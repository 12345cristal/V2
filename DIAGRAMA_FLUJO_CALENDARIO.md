# ğŸ¨ DIAGRAMA DE FLUJO - SISTEMA DE CITAS CON GOOGLE CALENDAR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND ANGULAR                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Componente: GestiÃ³n de Citas (Solo COORDINADOR)               â”‚   â”‚
â”‚  â”‚  - Formulario de nueva cita                                     â”‚   â”‚
â”‚  â”‚  - Vista de calendario                                          â”‚   â”‚
â”‚  â”‚  - Acciones: Crear / Reprogramar / Cancelar                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP Request (JWT Token)
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FASTAPI BACKEND                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CAPA 1: ENDPOINTS (citas_calendario.py)                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  require_admin_or_coordinator()                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Valida JWT token                                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Verifica rol_id in [1, 2]                              â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                         â†“ AUTORIZADO                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  POST /citas-calendario/                                   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Validar datos con CitaCreate schema                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Verificar que existan: niÃ±o, terapeuta, terapia       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Crear objeto Cita                                      â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CAPA 2: TRANSACCIÃ“N DE BASE DE DATOS                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  db.add(nueva_cita)                                      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  db.flush()  â† Obtiene ID sin commit                     â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CAPA 3: SERVICIO GOOGLE CALENDAR                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  google_calendar_service.esta_configurado?               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ SÃ â†’ Crear evento en Google Calendar                 â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   â”œâ”€ Construir tÃ­tulo y descripciÃ³n                   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   â”œâ”€ _crear_evento_dict()                             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   â”œâ”€ service.events().insert()                        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€ Retornar: google_event_id, google_calendar_link  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ NO â†’ Log advertencia, continuar sin sincronizar      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CAPA 4: FINALIZACIÃ“N DE TRANSACCIÃ“N                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  nueva_cita.google_event_id = resultado['id']            â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  nueva_cita.sincronizado_calendar = True                 â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  db.commit() â† Persiste TODO en BD                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  db.refresh(nueva_cita)                                  â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  MANEJO DE ERRORES                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ HTTPException â†’ db.rollback()                        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Exception general â†’ db.rollback()                    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Log error + HTTPException(500)                       â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Response: CitaRead (JSON)
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ALMACENAMIENTO                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   MYSQL DATABASE            â”‚  â”‚   GOOGLE CALENDAR                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Tabla: citas         â”‚  â”‚  â”‚  â”‚  Evento sincronizado       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ id: 42            â”‚  â”‚  â”‚  â”‚  â”œâ”€ Summary: Terapia...    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ nino_id: 5        â”‚  â”‚  â”‚  â”‚  â”œâ”€ Start: 2025-12-20      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ terapeuta_id: 3   â”‚  â”‚  â”‚  â”‚  â”‚    10:00                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ fecha: 2025-12-20 â”‚  â”‚  â”‚  â”‚  â”œâ”€ End: 11:00            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ hora_inicio: 10:00â”‚  â”‚  â”‚  â”‚  â”œâ”€ Location: Centro...   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ google_event_id:  â”‚â—„â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â–ºâ”‚ Event ID: abc123xyz   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   "abc123xyz"      â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ sincronizado: 1   â”‚  â”‚  â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ creado_por: 2     â”‚  â”‚  â”‚  â”‚  NOTIFICACIONES AUTOMÃTICAS: â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  â€¢ Email 1 dÃ­a antes        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â€¢ Popup 30 min antes       â”‚ â”‚
â”‚                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO DE REPROGRAMACIÃ“N

```
FRONTEND (Coordinador)
   â”‚
   â”œâ”€ PUT /api/v1/citas-calendario/42/reprogramar
   â”‚  Body: { nueva_fecha, nueva_hora_inicio, nueva_hora_fin, motivo }
   â–¼
BACKEND
   â”‚
   â”œâ”€ Validar JWT + Rol COORDINADOR
   â”œâ”€ Buscar cita con ID 42
   â”œâ”€ Validar estado (solo PROGRAMADA/CONFIRMADA)
   â”‚
   â”œâ”€ ACTUALIZAR EN BD:
   â”‚  â””â”€ cita.fecha = nueva_fecha
   â”‚     cita.hora_inicio = nueva_hora_inicio
   â”‚     cita.observaciones += motivo
   â”‚
   â”œâ”€ ACTUALIZAR EN GOOGLE CALENDAR:
   â”‚  â””â”€ google_calendar_service.actualizar_evento(
   â”‚        google_event_id,
   â”‚        nueva_fecha,
   â”‚        nueva_hora_inicio,
   â”‚        nueva_hora_fin
   â”‚     )
   â”‚
   â””â”€ db.commit() â†’ Respuesta exitosa
   
RESULTADO
   â”œâ”€ BD actualizada âœ…
   â”œâ”€ Google Calendar actualizado âœ…
   â””â”€ Notificaciones automÃ¡ticas enviadas con nueva fecha âœ…
```

---

## ğŸš« FLUJO DE CANCELACIÃ“N

```
FRONTEND (Coordinador)
   â”‚
   â”œâ”€ PUT /api/v1/citas-calendario/42/cancelar
   â”‚  Body: { motivo_cancelacion, eliminar_de_google_calendar: true }
   â–¼
BACKEND
   â”‚
   â”œâ”€ Buscar estado "CANCELADA" en BD
   â”‚
   â”œâ”€ ACTUALIZAR EN BD:
   â”‚  â””â”€ cita.estado_id = CANCELADA
   â”‚     cita.motivo_cancelacion = motivo
   â”‚     cita.fecha_cancelacion = NOW()
   â”‚     cita.cancelado_por = current_user.id
   â”‚
   â”œâ”€ ELIMINAR DE GOOGLE CALENDAR:
   â”‚  â””â”€ google_calendar_service.eliminar_evento(google_event_id)
   â”‚
   â””â”€ db.commit() â†’ Respuesta exitosa
   
RESULTADO
   â”œâ”€ Estado cambiado a CANCELADA âœ…
   â”œâ”€ Evento eliminado de Google Calendar âœ…
   â”œâ”€ AuditorÃ­a completa (quiÃ©n, cuÃ¡ndo, por quÃ©) âœ…
   â””â”€ OpciÃ³n de crear cita de reposiciÃ³n (futuro) â³
```

---

## ğŸ“Š FLUJO DE CONSULTA DE CALENDARIO

```
FRONTEND
   â”‚
   â”œâ”€ GET /api/v1/citas-calendario/calendario
   â”‚  Params: ?fecha_inicio=2025-12-01&fecha_fin=2025-12-31&terapeuta_id=3
   â–¼
BACKEND
   â”‚
   â”œâ”€ Construir query SQLAlchemy
   â”‚  SELECT * FROM citas
   â”‚  WHERE fecha >= '2025-12-01'
   â”‚    AND fecha <= '2025-12-31'
   â”‚    AND terapeuta_id = 3
   â”‚  ORDER BY fecha, hora_inicio
   â”‚
   â””â”€ Retornar lista de CitaRead
   
FRONTEND
   â”‚
   â””â”€ Renderizar en componente de calendario
      â”œâ”€ Vista mensual
      â”œâ”€ Vista semanal
      â””â”€ Vista de lista
```

---

## ğŸ” FLUJO DE SEGURIDAD

```
REQUEST CON JWT
   â”‚
   â”œâ”€ Header: Authorization: Bearer <token>
   â–¼
TokenInterceptor (Angular)
   â”‚
   â””â”€ Agrega automÃ¡ticamente el header a todas las peticiones HTTP
   
BACKEND: require_admin_or_coordinator
   â”‚
   â”œâ”€ 1. Decodificar JWT token
   â”‚     â””â”€ Extraer user_id
   â”‚
   â”œâ”€ 2. Buscar usuario en BD
   â”‚     â””â”€ SELECT * FROM usuarios WHERE id = user_id
   â”‚
   â”œâ”€ 3. Verificar que usuario estÃ© activo
   â”‚     â””â”€ IF NOT usuario.activo â†’ 403 Forbidden
   â”‚
   â”œâ”€ 4. Verificar rol
   â”‚     â””â”€ IF usuario.rol_id NOT IN [1, 2] â†’ 403 Forbidden
   â”‚
   â””â”€ 5. Usuario autorizado âœ…
      â””â”€ Ejecutar endpoint
```

---

## ğŸ›¡ï¸ MANEJO DE ERRORES

```
TRY:
   â”œâ”€ Validar datos
   â”œâ”€ Crear en BD (flush)
   â”œâ”€ Sincronizar Google Calendar
   â””â”€ Commit
   
CATCH HTTPException:
   â”œâ”€ db.rollback()
   â””â”€ raise (propagar error al frontend)
   
CATCH Exception general:
   â”œâ”€ Log error completo
   â”œâ”€ db.rollback()
   â””â”€ HTTPException(500, "Error al crear cita")
   
FINALLY:
   â””â”€ db.close() (automÃ¡tico con depends)
```

---

## ğŸ“ˆ ESCALABILIDAD

### LÃ­mites Actuales
- **MySQL:** Millones de registros sin problema
- **Google Calendar API:** 1,000,000 requests/dÃ­a
- **FastAPI:** Miles de requests/segundo

### Optimizaciones Implementadas
âœ… Ãndices en google_event_id, fecha_creacion, sincronizado_calendar  
âœ… Foreign keys con ON DELETE SET NULL (no rompe relaciones)  
âœ… Queries optimizados con filtros  
âœ… CachÃ© de conexiÃ³n de Google Calendar  

### Futuras Mejoras
- [ ] CachÃ© de Redis para citas frecuentes
- [ ] Webhooks de Google Calendar para actualizaciones bidireccionales
- [ ] PaginaciÃ³n en listado de calendario
- [ ] WebSockets para notificaciones en tiempo real

---

**Desarrollado con:** â¤ï¸ por Backend Senior Developer  
**Stack:** FastAPI + SQLAlchemy + Google Calendar API + MySQL + Pydantic v2
