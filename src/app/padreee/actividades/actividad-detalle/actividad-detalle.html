<div class="detalle-wrapper">

  @if (!asignacion) {
    <p class="estado">Selecciona una actividad de la lista para ver los detalles.</p>
  }

  @if (asignacion) {

    <header class="header">
      <h2>{{ asignacion.actividadTitulo }}</h2>
      <p class="subtitle">
        Para: {{ asignacion.ninoNombre }}
      </p>
    </header>

    <section class="card">
      <h3>Descripción</h3>
      <p class="texto">
        {{ asignacion.actividadDescripcionCorta || 'Actividad asignada por el terapeuta.' }}
      </p>

      @if (asignacion.objetivoClinico) {
        <div class="bloque">
          <h4>Objetivo clínico</h4>
          <p>{{ asignacion.objetivoClinico }}</p>
        </div>
      }

      @if (asignacion.instruccionesPadres) {
        <div class="bloque">
          <h4>Instrucciones para realizar la actividad</h4>
          <p>{{ asignacion.instruccionesPadres }}</p>
        </div>
      }

      @if (asignacion.materialRequerido) {
        <div class="bloque">
          <h4>Material requerido</h4>
          <p>{{ asignacion.materialRequerido }}</p>
        </div>
      }

      <div class="info-extra">
        <span>Asignada: {{ asignacion.fechaAsignacion | date:'short' }}</span>
        @if (asignacion.fechaLimite) {
          <span>Fecha límite: {{ asignacion.fechaLimite | date:'shortDate' }}</span>
        }
        @if (asignacion.duracionMinutos) {
          <span>Duración estimada: {{ asignacion.duracionMinutos }} min</span>
        }
      </div>
    </section>

    <section class="card">
      <h3>Marcar como completada</h3>

      @if (asignacion.completado) {
        <p class="ok-msg">
          Ya marcaste esta actividad como completada. ¡Muchas gracias por apoyar el proceso de tu hijo!
        </p>

        @if (asignacion.fechaCompletado) {
          <p class="info-fecha">
            Fecha de completado: {{ asignacion.fechaCompletado | date:'short' }}
          </p>
        }
      } @else {
        <form [formGroup]="formCompletar" (ngSubmit)="marcarCompletada()">

          <div class="field">
            <label>Cuéntanos cómo le fue a tu hijo</label>
            <textarea
              rows="3"
              formControlName="comentariosPadres"
              placeholder="Ej. Al principio se distrajo, pero al final terminó la actividad y se mostró contento.">
            </textarea>
          </div>

          <button
            type="submit"
            class="btn-primary"
            [disabled]="guardando">
            @if (guardando) {
              Guardando...
            } @else {
              Marcar como completada
            }
          </button>
        </form>
      }
    </section>

    <section class="card">
      <h3>Calificar al tutor</h3>
      <p class="ayuda">
        Esta calificación sirve para que el centro mejore el acompañamiento. No se muestra al niño.
      </p>

      <div class="rating-row">
        @for (star of [1,2,3,4,5]; track star) {
          <button
            type="button"
            class="star"
            [class.active]="star <= formRating.value.puntuacion"
            (click)="setRating(star)">
            ★
          </button>
        }
      </div>

      <form [formGroup]="formRating" (ngSubmit)="enviarRating()">
        <div class="field">
          <label>Comentario (opcional)</label>
          <textarea
            rows="2"
            formControlName="comentario"
            placeholder="Ej. Nos explicó muy claro, gracias por el apoyo.">
          </textarea>
        </div>

        <button type="submit" class="btn-secondary">
          Enviar calificación
        </button>
      </form>
    </section>
  }
</div>
