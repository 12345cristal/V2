<div class="perfil-wrapper">

  <!-- HEADER -->
  <header class="page-header">
    <div class="page-title">
      <h1>Mi Perfil</h1>
      <p>Administra tu información personal, documentos y seguridad</p>
    </div>
  </header>

  <!-- ERROR ALERT -->
  @if (error()) {
    <div class="alert alert-error">
      <mat-icon>error</mat-icon>
      {{ error() }}
    </div>
  }

  <!-- LOADING -->
  @if (cargando()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando datos...</p>
    </div>
  } @else if (datosPersonales()) {
    
    <!-- COMPLETITUD -->
    <div class="completitud-card">
      <div class="completitud-header">
        <h3>Completitud de Perfil</h3>
        <span class="completitud-porcentaje">{{ completitud() }}%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="completitud()" 
             [style.background-color]="obtenerColorCompletitud()"></div>
      </div>
      
      @if (documentosFaltantes().length > 0) {
        <div class="alertas-faltantes">
          <h4>Elementos faltantes:</h4>
          <ul>
            @for (alerta of documentosFaltantes(); track alerta) {
              <li>
                <mat-icon>info</mat-icon>
                {{ alerta }}
              </li>
            }
          </ul>
        </div>
      } @else {
        <div class="completitud-completa">
          <mat-icon>check_circle</mat-icon>
          <p>¡Perfil completamente configurado!</p>
        </div>
      }
    </div>

    <!-- TABS NAVIGATION -->
    <nav class="tabs-navigation">
      <button class="tab-btn" [class.activo]="tabActiva() === 'datos'" (click)="cambiarTab('datos')">
        <mat-icon>person</mat-icon>
        <span>Datos Personales</span>
      </button>
      <button class="tab-btn" [class.activo]="tabActiva() === 'documentos'" (click)="cambiarTab('documentos')">
        <mat-icon>description</mat-icon>
        <span>Documentos</span>
      </button>
      <button class="tab-btn" [class.activo]="tabActiva() === 'seguridad'" (click)="cambiarTab('seguridad')">
        <mat-icon>lock</mat-icon>
        <span>Seguridad</span>
      </button>
    </nav>

    <!-- TAB: DATOS PERSONALES -->
    @if (tabActiva() === 'datos') {
      <section class="tab-content">
        
        <!-- AVATAR SECTION -->
        <div class="avatar-section">
          <div class="avatar-display">
            @if (datosPersonales()?.foto_perfil) {
              <img [src]="datosPersonales()?.foto_perfil" alt="Foto de perfil" class="avatar-image" />
            } @else {
              <div class="avatar-placeholder">
                <mat-icon>person</mat-icon>
              </div>
            }
          </div>
          
          @if (!editandoDatos()) {
            <label class="upload-label">
              <mat-icon>upload</mat-icon>
              <span>Cambiar foto</span>
              <input type="file" accept="image/*" (change)="subirFoto($event)" hidden />
            </label>
          }
        </div>

        <!-- FORM -->
        <form [formGroup]="formDatos" class="datos-form">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre *</label>
              <input type="text" formControlName="nombre" [readonly]="!editandoDatos()" />
            </div>
            <div class="form-group">
              <label>Apellido *</label>
              <input type="text" formControlName="apellido" [readonly]="!editandoDatos()" />
            </div>
          </div>

          <div class="form-group">
            <label>Email *</label>
            <input type="email" formControlName="email" [readonly]="!editandoDatos()" />
            <small>Tu email es tu usuario del sistema</small>
          </div>

          <div class="form-group">
            <label>Teléfono</label>
            <input type="tel" formControlName="telefono" [readonly]="!editandoDatos()" />
          </div>

          <div class="form-group">
            <label>Ciudad</label>
            <input type="text" formControlName="ciudad" [readonly]="!editandoDatos()" />
          </div>

          <div class="form-group">
            <label>Dirección</label>
            <textarea formControlName="direccion" rows="3" [readonly]="!editandoDatos()"></textarea>
          </div>

          <!-- INFO -->
          <div class="info-card">
            <mat-icon>info</mat-icon>
            <div>
              <p class="info-title">Información importante</p>
              <p class="info-text">Ingresaste al sistema el {{ formatearFecha(datosPersonales()?.fecha_ingreso) }}</p>
            </div>
          </div>

          <!-- ACTIONS -->
          <div class="form-actions">
            @if (!editandoDatos()) {
              <button type="button" class="btn-primary" (click)="habilitarEdicion()">
                <mat-icon>edit</mat-icon>
                Editar datos
              </button>
            } @else {
              <button type="button" class="btn-secondary" (click)="cancelarEdicion()">
                Cancelar
              </button>
              <button type="button" class="btn-primary" (click)="guardarDatos()" [disabled]="formDatos.invalid">
                <mat-icon>save</mat-icon>
                Guardar cambios
              </button>
            }
          </div>
        </form>
      </section>
    }

    <!-- TAB: DOCUMENTOS -->
    @if (tabActiva() === 'documentos') {
      <section class="tab-content">
        
        <!-- UPLOAD SECTION -->
        <div class="upload-section">
          <div class="upload-card">
            <div class="upload-icon">
              <mat-icon>description</mat-icon>
            </div>
            <h3>Currículum Vitae (CV)</h3>
            <p class="upload-hint">PDF, DOC, DOCX - Máximo 5MB</p>
            <label class="upload-btn">
              <mat-icon>cloud_upload</mat-icon>
              Subir CV
              <input type="file" accept=".pdf,.doc,.docx" 
                     (change)="subirDocumento('CV', $event)" hidden />
            </label>
          </div>

          <div class="upload-card">
            <div class="upload-icon">
              <mat-icon>verified</mat-icon>
            </div>
            <h3>Certificados</h3>
            <p class="upload-hint">PDF, JPG, PNG - Máximo 5MB</p>
            <label class="upload-btn">
              <mat-icon>cloud_upload</mat-icon>
              Subir certificado
              <input type="file" accept=".pdf,.jpg,.jpeg,.png" 
                     (change)="subirDocumento('CERTIFICADO', $event)" hidden />
            </label>
          </div>
        </div>

        <!-- DOCUMENTS LIST -->
        @if (datosPersonales()?.documentos && datosPersonales()!.documentos.length > 0) {
          <div class="documentos-list">
            <h3>Tus documentos</h3>
            <div class="documentos-grid">
              @for (doc of datosPersonales()?.documentos; track doc.id) {
                <div class="documento-card">
                  <div class="documento-icon">
                    <mat-icon>{{ obtenerIconoDocumento(doc.tipo) }}</mat-icon>
                  </div>
                  <div class="documento-info">
                    <h4>{{ doc.nombre }}</h4>
                    <p class="documento-tipo">{{ doc.tipo }}</p>
                    <p class="documento-fecha">{{ formatearFecha(doc.fecha_carga) }}</p>
                  </div>
                  <div class="documento-actions">
                    <button class="icon-btn" (click)="descargarDocumento(doc)" title="Descargar">
                      <mat-icon>download</mat-icon>
                    </button>
                    <button class="icon-btn danger" (click)="eliminarDocumento(doc.id)" title="Eliminar">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        } @else {
          <div class="empty-state">
            <mat-icon>folder_open</mat-icon>
            <p>No hay documentos aún</p>
            <small>Sube tus documentos para completar tu perfil</small>
          </div>
        }
      </section>
    }

    <!-- TAB: SEGURIDAD -->
    @if (tabActiva() === 'seguridad') {
      <section class="tab-content">
        
        <div class="seguridad-card">
          <div class="seguridad-header">
            <mat-icon>lock</mat-icon>
            <div>
              <h3>Contraseña</h3>
              <p class="seguridad-hint">Cambia tu contraseña regularmente para mantener tu cuenta segura</p>
            </div>
          </div>
          <button class="btn-primary" (click)="abrirModalPassword()">
            <mat-icon>vpn_key</mat-icon>
            Cambiar contraseña
          </button>
        </div>

        <div class="seguridad-card">
          <div class="seguridad-header">
            <mat-icon>info</mat-icon>
            <div>
              <h3>Tu rol en el sistema</h3>
              <p class="seguridad-hint">Los roles definen tus permisos y acciones disponibles</p>
            </div>
          </div>
          <div class="roles-list">
            @for (rol of datosPersonales()?.roles; track rol) {
              <span class="role-badge">{{ rol }}</span>
            }
          </div>
        </div>

      </section>
    }

  }

</div>

<!-- MODAL: CAMBIAR CONTRASEÑA -->
@if (mostrarModalPassword()) {
  <div class="modal-overlay" (click)="cerrarModalPassword()">
    <div class="modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h2>Cambiar contraseña</h2>
        <button class="close-btn" (click)="cerrarModalPassword()">
          <mat-icon>close</mat-icon>
        </button>
      </header>

      <form [formGroup]="formPassword" class="modal-body">
        <div class="form-group">
          <label>Contraseña actual *</label>
          <input type="password" formControlName="passwordActual" 
                 placeholder="Ingresa tu contraseña actual" />
        </div>

        <div class="form-group">
          <label>Nueva contraseña *</label>
          <input type="password" formControlName="passwordNueva" 
                 placeholder="Ingresa la nueva contraseña (mín. 6 caracteres)" />
        </div>

        <div class="form-group">
          <label>Confirmar nueva contraseña *</label>
          <input type="password" formControlName="confirmarPassword" 
                 placeholder="Repite la nueva contraseña" />
          @if (formPassword.get('confirmarPassword')?.hasError('mismatch') && 
               formPassword.get('confirmarPassword')?.touched) {
            <small class="error-msg">Las contraseñas no coinciden</small>
          }
        </div>
      </form>

      <footer class="modal-footer">
        <button class="btn-secondary" (click)="cerrarModalPassword()">
          Cancelar
        </button>
        <button class="btn-primary" (click)="cambiarPassword()" 
                [disabled]="formPassword.invalid">
          <mat-icon>save</mat-icon>
          Cambiar contraseña
        </button>
      </footer>
    </div>
  </div>
}
