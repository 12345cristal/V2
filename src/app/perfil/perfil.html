<div class="perfil-wrapper">

  <!-- HEADER -->
  <header class="page-header">
    <div class="page-title">
      <h1>Mi Perfil</h1>
      <p>Administra tu información personal, documentos y seguridad</p>
    </div>
  </header>

  <!-- ERROR ALERT -->
  @if (error()) {
  <div class="alert alert-error">
    <mat-icon>error</mat-icon>
    {{ error() }}
  </div>
  }

  <!-- SUCCESS ALERT -->
  @if (successMsg()) {
  <div class="alert alert-success">
    <mat-icon>check_circle</mat-icon>
    {{ successMsg() }}
  </div>
  }

  <!-- LOADING -->
  @if (cargando()) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>
  } @else if (datosPersonales()) {

  <!-- COMPLETITUD -->
  <div class="completitud-card">
    <div class="completitud-header">
      <h3>Completitud de Perfil</h3>
      <span class="completitud-porcentaje">{{ completitud() }}%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="completitud()"
        [style.background-color]="obtenerColorCompletitud()"></div>
    </div>

    @if (documentosFaltantes().length > 0) {
    <div class="alertas-faltantes">
      <h4>Elementos faltantes:</h4>
      <ul>
        @for (alerta of documentosFaltantes(); track alerta) {
        <li>
          <mat-icon>info</mat-icon>
          {{ alerta }}
        </li>
        }
      </ul>
    </div>
    } @else {
    <div class="completitud-completa">
      <mat-icon>check_circle</mat-icon>
      <p>¡Perfil completamente configurado!</p>
    </div>
    }
  </div>

  <!-- TABS NAVIGATION -->
  <nav class="tabs-navigation">
    <button class="tab-btn" [class.activo]="tabActiva() === 'datos'"
      (click)="cambiarTab('datos')">
      <mat-icon>person</mat-icon>
      <span>Datos Personales</span>
    </button>
    <button class="tab-btn" [class.activo]="tabActiva() === 'documentos'"
      (click)="cambiarTab('documentos')">
      <mat-icon>description</mat-icon>
      <span>Documentos</span>
    </button>
    <button class="tab-btn" [class.activo]="tabActiva() === 'seguridad'"
      (click)="cambiarTab('seguridad')">
      <mat-icon>lock</mat-icon>
      <span>Seguridad</span>
    </button>
  </nav>

  <!-- TAB: DATOS PERSONALES -->
  @if (tabActiva() === 'datos') {
  <section class="tab-content">

    <!-- AVATAR SECTION -->
    <div class="avatar-section">
      <div class="avatar-display">
        @if (fotoPreview()) {
        <img [src]="getSafeUrl(fotoPreview()!.preview)" alt="Vista previa foto"
          class="avatar-image" />
        <button class="remove-preview-btn" (click)="eliminarFotoPreview()"
          type="button" title="Quitar foto seleccionada">
          <mat-icon>close</mat-icon>
        </button>
        } @else if (datosPersonales()?.foto_perfil) {
        <img [src]="datosPersonales()?.foto_perfil" alt="Foto de perfil"
          class="avatar-image" />
        } @else {
        <div class="avatar-placeholder">
          <mat-icon>person</mat-icon>
        </div>
        }
      </div>

      <label class="upload-label">
        <mat-icon>upload</mat-icon>
        <span>{{ fotoPreview() ? 'Cambiar foto seleccionada' : 'Subir foto' }}</span>
        <input type="file" accept="image/*" (change)="onFotoSeleccionada($event)"
          hidden />
      </label>
      <small class="upload-hint">JPG, PNG - Máximo 5MB</small>
    </div>

    <!-- INFO PERSONAL (Solo lectura) -->
    <div class="info-personal-card">
      <h3>Información Personal</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>Nombre completo:</label>
          <p>{{ getNombreCompleto() }}</p>
        </div>
        <div class="info-item">
          <label>Fecha de nacimiento:</label>
          <p>{{ formatearFecha(datosPersonales()?.fecha_nacimiento) }}</p>
        </div>
        <div class="info-item">
          <label>Fecha de ingreso:</label>
          <p>{{ formatearFecha(datosPersonales()?.fecha_ingreso) }}</p>
        </div>
        <div class="info-item">
          <label>Estado laboral:</label>
          <p>{{ datosPersonales()?.estado_laboral || 'N/A' }}</p>
        </div>
      </div>
    </div>

    <!-- FORM EDITABLE -->
    <form [formGroup]="formDatos" class="datos-form">

      <h3>Contacto</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Teléfono personal</label>
          <input type="tel" formControlName="telefono_personal"
            placeholder="Ej: 555-1234-5678" />
        </div>
        <div class="form-group">
          <label>Correo personal</label>
          <input type="email" formControlName="correo_personal"
            placeholder="tu@email.com" />
        </div>
      </div>

      <h3>Datos Profesionales</h3>
      <div class="form-group">
        <label>Especialidades</label>
        <input type="text" formControlName="especialidades"
          placeholder="Ej: Lenguaje, TEA, Conductual" />
        <small>Separa con comas si son varias</small>
      </div>

      <div class="form-group">
        <label>Experiencia</label>
        <textarea formControlName="experiencia" rows="4"
          placeholder="Describe tu experiencia profesional..."></textarea>
      </div>

      <h3>Domicilio</h3>
      <div class="form-group">
        <label>Calle y número</label>
        <input type="text" formControlName="domicilio_calle"
          placeholder="Calle Principal #123" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Colonia</label>
          <input type="text" formControlName="domicilio_colonia"
            placeholder="Centro" />
        </div>
        <div class="form-group">
          <label>Código Postal</label>
          <input type="text" formControlName="domicilio_cp" placeholder="12345" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Municipio</label>
          <input type="text" formControlName="domicilio_municipio"
            placeholder="Ciudad" />
        </div>
        <div class="form-group">
          <label>Estado</label>
          <input type="text" formControlName="domicilio_estado"
            placeholder="Estado" />
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="form-actions">
        @if (hayCambios()) {
        <button type="button" class="btn-secondary" (click)="cancelarEdicion()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        <button type="button" class="btn-primary" (click)="guardarDatos()"
          [disabled]="guardando() || formDatos.invalid">
          @if (guardando()) {
          <span class="spinner-small"></span>
          } @else {
          <mat-icon>save</mat-icon>
          }
          {{ guardando() ? 'Guardando...' : 'Guardar cambios' }}
        </button>
        } @else {
        <div class="info-message">
          <mat-icon>info</mat-icon>
          <span>Modifica los campos o sube archivos para habilitar el botón
            Guardar</span>
        </div>
        }
      </div>
    </form>
  </section>
  }

  <!-- TAB: DOCUMENTOS -->
  @if (tabActiva() === 'documentos') {
  <section class="tab-content">

    <!-- CV SECTION -->
    <div class="documento-seccion">
      <h3>
        <mat-icon>description</mat-icon>
        Currículum Vitae (CV)
      </h3>

      <!-- Preview CV -->
      @if (cvPreview()) {
      <div class="documento-preview">
        <div class="preview-header">
          <span class="preview-nombre">{{ cvPreview()!.file.name }}</span>
          <button class="icon-btn danger" (click)="eliminarCvPreview()"
            type="button" title="Eliminar">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        <div class="preview-body">
          <iframe [src]="getSafeUrl(cvPreview()!.preview)" class="pdf-preview"
            frameborder="0"></iframe>
        </div>
      </div>
      } @else if (datosPersonales()?.cv_archivo) {
      <div class="documento-actual">
        <mat-icon>check_circle</mat-icon>
        <span>CV cargado correctamente</span>
        <a [href]="datosPersonales()?.cv_archivo" target="_blank"
          class="btn-link">
          <mat-icon>visibility</mat-icon>
          Ver CV actual
        </a>
      </div>
      } @else {
      <div class="documento-vacio">
        <mat-icon>info</mat-icon>
        <span>No has subido tu CV aún</span>
      </div>
      }

      <label class="upload-btn-secondary">
        <mat-icon>cloud_upload</mat-icon>
        {{ cvPreview() || datosPersonales()?.cv_archivo ? 'Cambiar CV' : 'Subir CV' }}
        <input type="file" accept=".pdf" (change)="onCvSeleccionado($event)"
          hidden />
      </label>
      <small class="upload-hint">Solo PDF - Máximo 10MB</small>
    </div>

    <!-- DOCUMENTOS EXTRA SECTION -->
    <div class="documento-seccion">
      <h3>
        <mat-icon>folder</mat-icon>
        Documentos Adicionales
      </h3>
      <p class="seccion-descripcion">Sube constancias, certificados o documentos
        complementarios</p>

      <!-- Previews documentos -->
      @if (documentosPreview().length > 0) {
      <div class="documentos-preview-grid">
        @for (doc of documentosPreview(); track $index) {
        <div class="mini-preview-card">
          <button class="remove-mini-btn" (click)="eliminarDocumentoPreview($index)"
            type="button">
            <mat-icon>close</mat-icon>
          </button>
          @if (doc.tipo === 'pdf') {
          <div class="mini-pdf-icon">
            <mat-icon>picture_as_pdf</mat-icon>
          </div>
          } @else {
          <img [src]="getSafeUrl(doc.preview)" class="mini-image-preview"
            alt="Preview" />
          }
          <span class="mini-nombre">{{ doc.file.name }}</span>
        </div>
        }
      </div>
      }

      <label class="upload-btn-secondary">
        <mat-icon>add</mat-icon>
        Agregar documentos
        <input type="file" accept=".pdf,image/*"
          (change)="onDocumentosSeleccionados($event)" multiple hidden />
      </label>
      <small class="upload-hint">PDF o imágenes - Máximo 10MB por archivo</small>
    </div>

  </section>
  }

  <!-- TAB: SEGURIDAD -->
  @if (tabActiva() === 'seguridad') {
  <section class="tab-content">

    <div class="seguridad-card">
      <div class="seguridad-header">
        <mat-icon>info</mat-icon>
        <div>
          <h3>Información del Sistema</h3>
          <p class="seguridad-hint">Datos de tu cuenta en el sistema</p>
        </div>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <label>Estado laboral:</label>
          <p>{{ datosPersonales()?.estado_laboral || 'N/A' }}</p>
        </div>
        <div class="info-item">
          <label>Total pacientes:</label>
          <p>{{ datosPersonales()?.total_pacientes || 0 }}</p>
        </div>
        <div class="info-item">
          <label>Sesiones por semana:</label>
          <p>{{ datosPersonales()?.sesiones_semana || 0 }}</p>
        </div>
        <div class="info-item">
          <label>Rating:</label>
          <p>{{ datosPersonales()?.rating || 'N/A' }}</p>
        </div>
      </div>
    </div>

  </section>
  }

  }

</div>

<!-- MODAL: CONFIRMACIÓN DE SUBIDA -->
@if (mostrarModalConfirmacion()) {
<div class="modal-overlay" (click)="cancelarConfirmacion()">
  <div class="modal" (click)="$event.stopPropagation()">
    <header class="modal-header">
      <h2>Confirmar subida de archivo</h2>
      <button class="close-btn" (click)="cancelarConfirmacion()">
        <mat-icon>close</mat-icon>
      </button>
    </header>

    <div class="modal-body">
      <div class="confirmacion-contenido">
        <mat-icon class="confirmacion-icon">
          @switch (archivoEnConfirmacion()?.tipo) {
          @case ('foto_perfil') {
            image
          }
          @case ('cv_archivo') {
            description
          }
          @case ('documentos_extra') {
            folder
          }
          }
        </mat-icon>

        <div class="confirmacion-info">
          <h3>
            @switch (archivoEnConfirmacion()?.tipo) {
            @case ('foto_perfil') {
              Foto de Perfil
            }
            @case ('cv_archivo') {
              Currículum Vitae
            }
            @case ('documentos_extra') {
              Documento Adicional
            }
            }
          </h3>
          <p class="archivo-nombre">{{ archivoEnConfirmacion()?.nombre }}</p>
          <p class="confirmacion-mensaje">
            @switch (archivoEnConfirmacion()?.tipo) {
            @case ('foto_perfil') {
              ¿Deseas subir esta foto como tu foto de perfil?
            }
            @case ('cv_archivo') {
              ¿Deseas subir este documento como tu CV?
            }
            @case ('documentos_extra') {
              ¿Deseas subir este documento?
            }
            }
          </p>
        </div>
      </div>
    </div>

    <footer class="modal-footer">
      <button class="btn-secondary" (click)="cancelarConfirmacion()">
        <mat-icon>close</mat-icon>
        Cancelar
      </button>
      <button class="btn-primary" (click)="confirmarSubida()" [disabled]="guardando()">
        @if (guardando()) {
        <span class="spinner-small"></span>
        } @else {
        <mat-icon>check_circle</mat-icon>
        }
        {{ guardando() ? 'Subiendo...' : 'Confirmar y subir' }}
      </button>
    </footer>
  </div>
</div>
}
