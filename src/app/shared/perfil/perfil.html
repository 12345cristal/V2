<div class="perfil-wrapper">

  <!-- LOADER -->
  @if (cargando()) {
    <div class="perfil-loading">
      <div class="spinner-large"></div>
      <h3>Cargando tu perfil...</h3>
    </div>
  }

  @if (!cargando()) {

    <!-- ALERTAS -->
    @if (mensajeExito()) {
      <div class="toast-notification success">{{ mensajeExito() }}</div>
    }
    @if (mensajeError()) {
      <div class="toast-notification error">{{ mensajeError() }}</div>
    }

    <!-- HEADER -->
    <div class="perfil-header">
      <div class="header-content">
        <div class="header-icon">
          <svg width="32" height="32" stroke="white">
            <circle cx="16" cy="10" r="6"></circle>
            <path d="M4 26c0-6 4-10 12-10s12 4 12 10"></path>
          </svg>
        </div>
        <div>
          <h1>Mi Perfil Profesional</h1>
          <p class="subtitle">Gestión de tu información laboral</p>
        </div>
      </div>

      <button
        class="btn-save"
        (click)="intentarGuardar()"
        [disabled]="guardando() || !dirtyState()">
        Guardar cambios
      </button>
    </div>

    <!-- AVATAR -->
    <section class="perfil-main">
      <div class="perfil-avatar">

        <div class="foto-container">
          <div class="foto">

            @if (fotoUrl()) {
              <img [src]="fotoUrl()" class="avatar-img" />
            } @else {
              <div class="avatar-placeholder">
                <svg width="48" height="48" stroke="#64748b">
                  <circle cx="24" cy="16" r="12"></circle>
                  <path d="M4 44c0-12 8-20 20-20s20 8 20 20"></path>
                </svg>
              </div>
            }

          </div>

          <button class="foto-cambiar" (click)="abrirSelectorFoto(fileFoto)">
            <svg width="24" height="24" stroke="white">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 8v8M8 12h8"></path>
            </svg>
          </button>

          <input #fileFoto type="file" accept="image/*" hidden (change)="onFotoChange($event)">
        </div>

        <div class="avatar-info">
          <strong>
            {{ perfil()?.nombres }} {{ perfil()?.apellido_paterno }} {{ perfil()?.apellido_materno }}
          </strong>
          <span class="rol-badge">{{ perfil()?.especialidad_principal }}</span>
          <p class="user-email">{{ perfil()?.correo_personal }}</p>
        </div>

      </div>

      <!-- STATS -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-valor">{{ perfil()?.total_pacientes }}</div>
          <div class="stat-label">PACIENTES</div>
        </div>

        <div class="stat-card">
          <div class="stat-valor">{{ perfil()?.sesiones_semana }}</div>
          <div class="stat-label">SESIONES / SEMANA</div>
        </div>

        <div class="stat-card">
          <div class="stat-valor">⭐ {{ perfil()?.rating }}</div>
          <div class="stat-label">CALIFICACIÓN</div>
        </div>

        <div class="stat-card">
          <div class="stat-valor">{{ perfil()?.estado_laboral }}</div>
          <div class="stat-label">ESTADO</div>
        </div>
      </div>

      <!-- FORMULARIO -->
      <form [formGroup]="form" class="perfil-form">

        <section class="perfil-section">
          <h3>Información de contacto</h3>

          <div class="form-grid-2">
            <div class="form-field">
              <label>Teléfono *</label>
              <input formControlName="telefono_personal">
            </div>

            <div class="form-field">
              <label>Correo electrónico *</label>
              <input type="email" formControlName="correo_personal">
            </div>
          </div>
        </section>

        <section class="perfil-section">
          <h3>Perfil profesional</h3>

          <div class="form-grid-2">
            <div class="form-field">
              <label>Grado académico *</label>
              <input formControlName="grado_academico">
            </div>

            <div class="form-field">
              <label>Especialidades *</label>
              <input formControlName="especialidades">
            </div>
          </div>

          <div class="form-field">
            <label>Experiencia *</label>
            <textarea rows="4" formControlName="experiencia"></textarea>
          </div>
        </section>

        <section class="perfil-section">
          <h3>Domicilio</h3>

          <div class="form-grid-2">
            <div class="form-field">
              <label>Calle *</label>
              <input formControlName="domicilio_calle">
            </div>

            <div class="form-field">
              <label>Colonia *</label>
              <input formControlName="domicilio_colonia">
            </div>

            <div class="form-field">
              <label>Código Postal *</label>
              <input formControlName="domicilio_cp">
            </div>

            <div class="form-field">
              <label>Municipio *</label>
              <input formControlName="domicilio_municipio">
            </div>

            <div class="form-field">
              <label>Estado *</label>
              <input formControlName="domicilio_estado">
            </div>
          </div>
        </section>

        <section class="perfil-section">
          <h3>Currículum (PDF)</h3>

          <label class="cv-upload-label">
            <input type="file" accept="application/pdf" hidden (change)="onCvChange($event)">
            <div class="upload-icon">
              <svg width="48" height="48" stroke="#2563eb">
                <path d="M12 5v14M5 12h14"></path>
              </svg>
            </div>
            <span>Haz clic para subir un PDF</span>
          </label>

          @if (perfil()?.cv_archivo) {
            <div class="cv-actual-card">
              <div class="cv-icon">PDF</div>
              <div class="cv-info">
                <strong>CV cargado</strong>
                <a [href]="perfil()?.cv_archivo" target="_blank">Ver archivo</a>
              </div>
            </div>
          }

        </section>

      </form>
    </section>

  }

</div>
