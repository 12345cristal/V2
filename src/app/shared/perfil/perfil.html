<div class="perfil-wrapper">

  <!-- LOADING -->
  @if (cargando()) {
    <div class="perfil-loading">
      <div class="loading-content">
        <div class="spinner-large"></div>
        <h3>Cargando tu perfil</h3>
        <p>Espera un momento...</p>
      </div>
    </div>
  }

  <!-- CONTENIDO PRINCIPAL -->
  @if (!cargando()) {

    <!-- NOTIFICACIONES -->
    @if (mensajeExito()) {
      <div class="toast-notification success">{{ mensajeExito() }}</div>
    }

    @if (mensajeError()) {
      <div class="toast-notification error">{{ mensajeError() }}</div>
    }

    <!-- MODAL CONFIRMACIÓN -->
    @if (alertaConfirmacion()) {
      <div class="modal-overlay">
        <div class="modal">
          <h3>¿Guardar cambios?</h3>
          <p>Estás por actualizar tu información.</p>

          <div class="modal-actions">
            <button class="btn cancel" (click)="cancelarGuardado()">Cancelar</button>
            <button class="btn confirm" (click)="guardarPerfil()">Guardar</button>
          </div>
        </div>
      </div>
    }

    <!-- ENCABEZADO -->
    <div class="perfil-breadcrumb">
      <span class="active">Mi Perfil</span>
    </div>

    <header class="perfil-header">
      <div class="header-content">
        <div class="header-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>

        <div>
          <h1>Mi Perfil Profesional</h1>
          <p class="subtitle">Información personal y profesional actualizada</p>
        </div>
      </div>

      <button class="btn-save" (click)="intentarGuardar()" [disabled]="guardando() || !dirtyState()">
        Guardar cambios
      </button>
    </header>

    <!-- INFORMACIÓN PRINCIPAL -->
    <section class="perfil-main">

      <div class="perfil-avatar">
        <div class="foto-container">
          <div class="foto">

            <!-- Foto o placeholder -->
            @if (fotoUrl()) {
              <img [src]="fotoUrl()" alt="Perfil" class="avatar-img">
            } @else {
              <div class="avatar-placeholder">
                <svg width="48" height="48" viewBox="0 0 24 24" stroke="currentColor">
                  <circle cx="12" cy="7" r="4"></circle>
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                </svg>
              </div>
            }
          </div>

          <!-- Botón cambiar foto -->
          <label class="foto-cambiar">
            <input type="file" accept="image/*" hidden (change)="onFotoChange($event)">
            Cambiar foto
          </label>
        </div>

        <div class="avatar-info">
          <strong>{{ perfil()?.nombres }} {{ perfil()?.apellido_paterno }} {{ perfil()?.apellido_materno }}</strong>
          <span class="rol-badge">{{ perfil()?.especialidad_principal }}</span>
          <p class="user-email">{{ perfil()?.correo_personal }}</p>
        </div>
      </div>

      <!-- ESTADÍSTICAS -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-valor">{{ perfil()?.total_pacientes }}</div>
          <div class="stat-label">Pacientes</div>
        </div>

        <div class="stat-card">
          <div class="stat-valor">{{ perfil()?.sesiones_semana }}</div>
          <div class="stat-label">Sesiones/Semana</div>
        </div>

        <div class="stat-card">
          <div class="stat-valor">⭐ {{ perfil()?.rating }}</div>
          <div class="stat-label">Calificación</div>
        </div>

        <div class="stat-card">
          <div class="stat-valor">{{ perfil()?.estado_laboral }}</div>
          <div class="stat-label">Estado</div>
        </div>
      </div>
    </section>

    <!-- FORMULARIO DETALLADO -->
    <form [formGroup]="form" class="perfil-form">

      <!-- CONTACTO -->
      <section class="perfil-section">
        <h3>Información de contacto</h3>

        <div class="form-grid-2">

          <div class="form-field">
            <label>Teléfono *</label>
            <input formControlName="telefono_personal" placeholder="6681234567">
          </div>

          <div class="form-field">
            <label>Correo personal *</label>
            <input type="email" formControlName="correo_personal" placeholder="correo@ejemplo.com">
          </div>

        </div>
      </section>

      <!-- PROFESIONAL -->
      <section class="perfil-section">
        <h3>Perfil profesional</h3>

        <div class="form-grid-2">
          <div class="form-field">
            <label>Grado académico *</label>
            <input formControlName="grado_academico">
          </div>

          <div class="form-field">
            <label>Especialidades *</label>
            <input formControlName="especialidades">
          </div>
        </div>

        <div class="form-field">
          <label>Experiencia *</label>
          <textarea formControlName="experiencia" rows="4"></textarea>
        </div>
      </section>

      <!-- DOMICILIO -->
      <section class="perfil-section">
        <h3>Domicilio</h3>

        <div class="form-grid-2">

          <div class="form-field">
            <label>Calle *</label>
            <input formControlName="domicilio_calle">
          </div>

          <div class="form-field">
            <label>Colonia *</label>
            <input formControlName="domicilio_colonia">
          </div>

          <div class="form-field">
            <label>Código Postal *</label>
            <input formControlName="domicilio_cp">
          </div>

          <div class="form-field">
            <label>Municipio *</label>
            <input formControlName="domicilio_municipio">
          </div>

          <div class="form-field">
            <label>Estado *</label>
            <input formControlName="domicilio_estado">
          </div>

        </div>
      </section>

      <!-- CV -->
      <section class="perfil-section">
        <h3>Currículum (PDF)</h3>

        <label class="cv-upload-label">
          <input type="file" accept="application/pdf" hidden (change)="onCvChange($event)">
          Subir CV (PDF)
        </label>

        @if (perfil()?.cv_archivo) {
          <div class="cv-actual-card">
            <strong>CV actual:</strong>
            <a [href]="perfil()?.cv_archivo" target="_blank">Ver CV</a>
          </div>
        }
      </section>

    </form>

  }
</div>
