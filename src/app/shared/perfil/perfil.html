<div class="perfil-wrapper">

  <!-- ================= TOAST ================= -->
  @if (mostrarToast()) {
  <div
    class="toast"
    [class.success]="toastTipo() === 'success'"
    [class.error]="toastTipo() === 'error'">
    {{ toastMensaje() }}
  </div>
  }

  <!-- ================= MODAL CONFIRMAR ================= -->
  @if (mostrarModalConfirmar()) {
  <div class="modal-overlay" (click)="cancelarGuardado()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Confirmar cambios</h2>
      <p>¬øDeseas guardar los cambios realizados en tu perfil?</p>

      <div class="modal-actions">
        <button class="btn-outline" type="button" (click)="cancelarGuardado()">
          Cancelar
        </button>
        <button
          class="btn-primary"
          type="button"
          [disabled]="guardando()"
          (click)="confirmarGuardar()">
          {{ guardando() ? 'Guardando‚Ä¶' : 'Confirmar' }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- ================= MODAL PASSWORD ================= -->
  @if (mostrarModalPassword()) {
  <div class="modal-overlay" (click)="cerrarModalPassword()">
    <div class="modal-content password-modal"
      (click)="$event.stopPropagation()">
      <h2>Cambiar contrase√±a</h2>

      <div class="field">
        <label>Contrase√±a actual</label>
        <input type="password" [(ngModel)]="passwordActual">
      </div>

      <div class="field">
        <label>Nueva contrase√±a</label>
        <input type="password" [(ngModel)]="passwordNueva">
      </div>

      <div class="field">
        <label>Confirmar contrase√±a</label>
        <input type="password" [(ngModel)]="passwordConfirmar">
      </div>

      <div class="modal-actions">
        <button class="btn-outline" type="button"
          (click)="cerrarModalPassword()">
          Cancelar
        </button>
        <button class="btn-primary" type="button" (click)="cambiarPassword()">
          Cambiar contrase√±a
        </button>
      </div>
    </div>
  </div>
  }

  <!-- ================= LOADING ================= -->
  @if (cargando()) {
  <div class="perfil-loading">
    <div class="spinner-large"></div>
    <p>Cargando tu perfil‚Ä¶</p>
  </div>
  }

  @if (!cargando()) {

  <!-- ================= ALERTAS ================= -->
  @if (alertas().length > 0) {
  <div class="alertas-inline">
    @for (a of alertas(); track a) {
    <div class="alerta-inline warning">
      <span>‚ö†Ô∏è</span>
      <span>{{ a }}</span>
    </div>
    }
  </div>
  }

  <!-- ================= HEADER ================= -->
  <header class="perfil-header">
    <div class="perfil-title">
      <h1>Mi perfil profesional</h1>
      <p>
        {{ perfil()?.nombres }}
        {{ perfil()?.apellido_paterno }}
        {{ perfil()?.apellido_materno }}
      </p>
    </div>

    <button
      class="btn-primary"
      type="button"
      (click)="intentarGuardar()"
      [disabled]="!dirtyState() || guardando()">
      {{ guardando() ? 'Guardando‚Ä¶' : 'Guardar cambios' }}
    </button>
  </header>

  <!-- ================= CONTENIDO ================= -->
  <section class="perfil-main">

    <!-- ===== SIDEBAR ===== -->
    <aside class="perfil-sidebar">

      <!-- FOTO -->
      <div class="perfil-card">
        <h3>Foto de perfil</h3>

        <div class="avatar-box">
          @if (fotoUrl()) {
          <img [src]="fotoUrl()" alt="Foto de perfil" class="user-photo">
          } @else {
          <div class="avatar-placeholder">Sin foto</div>
          }

          <label class="btn-outline">
            Cambiar foto
            <input type="file" hidden accept="image/*"
              (change)="onFotoChange($event)">
          </label>
        </div>
      </div>

      <!-- DOCUMENTOS -->
      <div class="perfil-card documentos-card">
        <h3>Documentos profesionales</h3>

        <!-- CV -->
        <div class="documento-item principal">
          <div class="documento-info">
            <span class="documento-titulo">Curr√≠culum</span>
            <span class="documento-descripcion">Archivo PDF</span>
          </div>

          <label class="btn-outline">
            {{ cvFile ? 'Actualizar' : 'Subir' }}
            <input type="file" hidden accept="application/pdf"
              (change)="onCvChange($event)">
          </label>
        </div>

        <!-- CONSTANCIAS -->
        <div class="documento-item">
          <div class="documento-info">
            <span class="documento-titulo">Constancias / cursos</span>
            <span class="documento-descripcion">PDF o im√°genes</span>
          </div>

          <label class="btn-outline">
            Subir archivos
            <input
              type="file"
              hidden
              multiple
              accept="application/pdf,image/*"
              (change)="onDocsChange($event)">
          </label>
        </div>
      </div>

      <!-- SEGURIDAD -->
      <div class="perfil-card">
        <h3>Seguridad</h3>
        <p class="password-hint">
          Cambia tu contrase√±a peri√≥dicamente.
        </p>
        <button class="btn-warning" type="button"
          (click)="abrirCambioPassword()">
          Cambiar contrase√±a
        </button>
      </div>

    </aside>

    <!-- ===== FORMULARIO ===== -->
    <form class="perfil-content" [formGroup]="form">

      <!-- DATOS PERSONALES -->
      <section class="perfil-section readonly-section">
        <h2>Datos personales</h2>

        <div class="readonly-grid">
          <div class="readonly-field">
            <label>Nombre completo</label>
            <div class="readonly-value">
              {{ perfil()?.nombres }}
              {{ perfil()?.apellido_paterno }}
              {{ perfil()?.apellido_materno }}
            </div>
          </div>

          <div class="readonly-field">
            <label>Fecha de nacimiento</label>
            <div class="readonly-value">
              @if (perfil()?.fecha_nacimiento) {
              {{ perfil()?.fecha_nacimiento | date:'dd/MM/yyyy' }}
              } @else {
              No registrada
              }
            </div>
          </div>
        </div>
      </section>

      <!-- CONTACTO -->
      <section class="perfil-section perfil-card">
        <h2>Informaci√≥n de contacto</h2>

        <div class="grid-2">
          <div class="field">
            <label>Tel√©fono</label>
            <input formControlName="telefono_personal">
          </div>

          <div class="field">
            <label>Correo</label>
            <input type="email" formControlName="correo_personal">
          </div>

          <div class="field field-full">
            <label>Grado acad√©mico</label>
            <input formControlName="grado_academico">
          </div>

          <div class="field field-full">
            <label>Especialidades</label>
            <input formControlName="especialidades">
          </div>

          <div class="field field-full">
            <label>Experiencia</label>
            <textarea rows="4" formControlName="experiencia"></textarea>
          </div>
        </div>
      </section>

      <!-- VISOR CV -->
      <section class="perfil-section perfil-card">
        <h2>Curr√≠culum</h2>

        @if (!cvSafeUrl()) {
        <div class="info-box">
          <p>üìù Sube tu curr√≠culum PDF para poder verlo aqu√≠.</p>
        </div>
        }

        @if (cvSafeUrl()) {
        <div class="pdf-status">
          @if (cvFile) {
          <span class="status-badge">üì§ Listo para guardar</span>
          }
        </div>

        <app-pdf-viewer
          title="Curr√≠culum (PDF)"
          [safeUrl]="cvSafeUrl()"
          [filename]="cvNombre()"
          (abrir)="abrirCvEnOtraPestana()"
          (descargar)="descargarCv()">
        </app-pdf-viewer>
        }
      </section>

      <!-- VISOR CONSTANCIAS -->
      @if (docsPreview().length > 0) {
      <section class="perfil-section perfil-card">
        <h2>Constancias / cursos</h2>

        <div class="docs-grid">
          @for (doc of docsPreview(); track doc.name) {
          <div class="doc-preview-card">

            <div class="doc-preview-head">
              <span class="doc-name">{{ doc.name }}</span>

              <div class="doc-actions">
                <button
                  class="btn-outline"
                  type="button"
                  (click)="abrirDocEnOtraPestana(doc.rawUrl)">
                  Abrir
                </button>
                @if (doc.isPdf) {
                <button
                  class="btn-primary"
                  type="button"
                  (click)="descargarDoc(doc.rawUrl, doc.name)">
                  Descargar
                </button>
                }
              </div>
            </div>

            @if (doc.isPdf) {
            <iframe
              class="pdf-frame"
              [src]="doc.safeUrl"
              loading="lazy">
            </iframe>
            } @else {
            <img
              class="img-frame"
              [src]="doc.safeUrl"
              alt="Documento">
            }
          </div>
          }
        </div>

        @if (documentosExtras.length > 0 && documentosExtras.length ===
        docsPreview().length) {
        <p class="docs-pending">‚è≥ {{ documentosExtras.length }} archivo(s)
          pendiente(s) de guardar</p>
        }
      </section>
      }

    </form>
  </section>
  }
</div>
