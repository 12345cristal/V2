<div class="chatbot-container">

  <!-- BOTÓN FLOTANTE -->
  <button
    class="chatbot-btn"
    (click)="toggleChat()"
    [class.activo]="chatAbierto()"
    aria-label="Abrir chat IA"
  >
    @if (!chatAbierto()) {
      <span class="material-icons">smart_toy</span>
    }
    @if (chatAbierto()) {
      <span class="material-icons">close</span>
    }
  </button>

  <!-- VENTANA CHAT -->
  @if (chatAbierto()) {
    <div class="chatbot-ventana">

      <!-- HEADER -->
      <header class="chat-header">
        <div class="header-info">
          <span class="material-icons avatar">psychology</span>
          <div>
            <h3>Asistente IA</h3>
            <p>Orientación en autismo (TEA)</p>
          </div>
        </div>

        <button
          class="btn-limpiar"
          (click)="limpiarChat()"
          title="Limpiar conversación"
        >
          <span class="material-icons">delete_outline</span>
        </button>
      </header>

    <!-- MENSAJES -->
    <section class="chat-mensajes" #mensajesRef>
      @for (mensaje of mensajes(); track trackByMensaje($index, mensaje)) {
        <div
          class="mensaje"
          [class.usuario]="mensaje.esUsuario"
          [class.bot]="!mensaje.esUsuario"
        >
          <div class="mensaje-contenido">
            <p [innerHTML]="formatTexto(mensaje.texto)"></p>
            <span class="mensaje-hora">
              {{ mensaje.timestamp | date:'shortTime' }}
            </span>
          </div>
        </div>
      }

      @if (cargando()) {
        <div class="mensaje bot">
          <div class="mensaje-contenido typing">
            <span></span><span></span><span></span>
          </div>
        </div>
      }
    </section>

    <!-- SUGERENCIAS -->
    @if (mensajes().length <= 1) {
      <section class="preguntas-sugeridas">
        <p class="sugerencias-titulo">Preguntas frecuentes</p>
        @for (pregunta of preguntasSugeridas; track pregunta) {
          <button
            class="btn-sugerencia"
            (click)="usarPreguntaSugerida(pregunta)"
          >
            {{ pregunta }}
          </button>
        }
      </section>
    }

    <!-- INPUT -->
    <footer class="chat-input">
      <input
        type="text"
        [ngModel]="mensajeActual()"
        (ngModelChange)="mensajeActual.set($event)"
        (keyup.enter)="enviarMensaje()"
        placeholder="Pregunta sobre terapias, rutinas o conducta…"
        [disabled]="cargando()"
      >

      <button
        class="btn-enviar"
        (click)="enviarMensaje()"
        [disabled]="!mensajeActual().trim() || cargando()"
        aria-label="Enviar mensaje"
      >
        <span class="material-icons">send</span>
      </button>
    </footer>

    </div>
  }
</div>
