<div class="detalle-wrapper">

  @if (error()) {
    <div class="alert error">{{ error() }}</div>
  }

  @if (cargando()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando información del paciente...</p>
    </div>
  }

  @if (!cargando() && paciente()) {

    <header class="header">
      <div class="info-header">
        <img class="foto"
             [src]="paciente()?.fotografiaUrl || 'assets/default-user.png'">

        <div>
          <h1>{{ paciente()?.nombreCompleto }}</h1>
          <p class="sub">
            {{ paciente()?.edad }} años • {{ paciente()?.diagnosticoPrincipal }}
          </p>
        </div>
      </div>

      <div class="progreso-box">
        <strong>{{ paciente()?.progresoGeneral ?? 0 }}%</strong>
        <span>Progreso general</span>
      </div>
    </header>

    @if (mensajeAccion()) {
      <div class="alert info">{{ mensajeAccion() }}</div>
    }

    @if (advertencias().length) {
      <div class="alert warning">
        <strong>Advertencias de la sesión:</strong>
        <ul>
          @for (a of advertencias(); track a) {
            <li>{{ a }}</li>
          }
        </ul>
      </div>
    }

    <!-- INFORMACIÓN EMOCIONAL -->
    <section class="card">
      <h2>Información emocional</h2>

      <ul class="info-list">
        <li><strong>Estímulos de ansiedad:</strong> {{ paciente()?.infoEmocional?.estimulosAnsiedad }}</li>
        <li><strong>Cosas que calman:</strong> {{ paciente()?.infoEmocional?.cosasQueCalman }}</li>
        <li><strong>Preferencias sensoriales:</strong> {{ paciente()?.infoEmocional?.preferenciasSensoriales }}</li>
        <li><strong>Palabras clave:</strong> {{ paciente()?.infoEmocional?.palabrasClave }}</li>
        <li><strong>Nivel de comprensión:</strong> {{ paciente()?.infoEmocional?.nivelComprensionDescripcion }}</li>
      </ul>
    </section>

    <!-- TERAPIAS -->
    <section class="card">
      <h2>Terapias asignadas</h2>

      @for (t of paciente()?.terapiasAsignadas ?? []; track t.id) {
        <div class="terapia-item">
          <strong>{{ t.tipoDescripcion }}</strong>
          <p>{{ t.diaNombre }} · {{ t.horaInicio }} — {{ t.horaFin }}</p>

          @if (t.sala) {
            <p>Sala: {{ t.sala }}</p>
          }
        </div>
      }
    </section>

    <!-- REPOSICIONES -->
    <section class="card">
      <h2>Reposiciones</h2>

      @if (!(paciente()?.reposiciones?.length)) {
        <p class="empty">No hay reposiciones registradas.</p>
      }

      @for (r of paciente()?.reposiciones ?? []; track r.id) {
        <div class="repo-item">
          <div>
            <strong>{{ r.fecha }}</strong>
            <p>{{ r.motivo }}</p>
          </div>
          <span class="estado">{{ r.estadoDescripcion }}</span>
        </div>
      }
    </section>

    <!-- BITÁCORA -->
    <section class="grid-bitacora">
      <app-bitacora-form 
        (submitBitacora)="onBitacoraSubmit($event)">
      </app-bitacora-form>

      <app-bitacora-historial 
  [pacienteId]="paciente()!.id">
</app-bitacora-historial>

    </section>

  }
</div>
