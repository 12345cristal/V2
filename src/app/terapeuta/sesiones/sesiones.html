<div class="wrap">
    <div class="head">
        <div>
            <h1>Sesiones del niño</h1>
            <p class="sub">Registra asistencia y observaciones después de cada
                terapia</p>
        </div>

        <button class="btn-outline" (click)="cargar()" [disabled]="cargando">
            {{ cargando ? 'Cargando…' : 'Actualizar' }}
        </button>
    </div>

    <!-- NUEVA SESIÓN -->
    <div class="card">
        <h2>Nueva sesión</h2>

        <div class="form">
            <label>
                Fecha y hora
                <input type="datetime-local" [(ngModel)]="fecha" name="fecha" />
            </label>

            <label class="chk">
                <input type="checkbox" [(ngModel)]="asistio" name="asistio" />
                ¿Asistió?
            </label>

            <label>
                Progreso (0-10)
                <input type="number" min="0" max="10" [(ngModel)]="progreso"
                    name="progreso" />
            </label>

            <label>
                Colaboración (0-10)
                <input type="number" min="0" max="10" [(ngModel)]="colaboracion"
                    name="colaboracion" />
            </label>

            <label class="full">
                Observaciones
                <textarea [(ngModel)]="observaciones" name="observaciones"
                    placeholder="Escribe observaciones clínicas..."></textarea>
            </label>

            <div class="actions">
                <button class="btn-primary" (click)="crearSesion()">
                    Guardar sesión
                </button>
            </div>

            <p class="hint" *ngIf="!terapiaNinoId">
                ⚠️ Falta <b>terapiaNinoId</b>. Pásalo como query param:
                <code>?terapiaNinoId=123</code>
            </p>
        </div>
    </div>

    <!-- HISTORIAL -->
    <div class="card">
        <div class="card-head">
            <h2>Historial</h2>
            <span class="badge">{{ sesiones.length }} sesiones</span>
        </div>

        <div *ngIf="cargando" class="empty">Cargando historial…</div>
        <div *ngIf="!cargando && sesiones.length === 0" class="empty">No hay
            sesiones registradas.</div>

        <div class="list" *ngIf="!cargando && sesiones.length > 0">
            <div class="row" *ngFor="let s of sesiones">
                <div class="row-top">
                    <div>
                        <p class="title">{{ formatFecha(s.fecha) }}</p>
                        <p class="sub2">Asistió: <b>{{ s.asistio ? 'Sí' : 'No'
                                }}</b></p>
                    </div>

                    <div class="right">
                        <span class="pill">Prog: {{ s.progreso ?? '—' }}</span>
                        <span class="pill">Colab: {{ s.colaboracion ?? '—'
                            }}</span>
                    </div>
                </div>

                <!-- Vista normal -->
                <div *ngIf="!editando[s.id]" class="body">
                    <p class="obs"><b>Observaciones:</b> {{ s.observaciones ||
                        '—' }}</p>

                    <div class="row-actions">
                        <button class="btn-outline"
                            (click)="empezarEditar(s)">Editar</button>
                    </div>
                </div>

                <!-- Edición -->
                <div *ngIf="editando[s.id]" class="body edit">
                    <label class="chk">
                        <input type="checkbox"
                            [(ngModel)]="tmp[s.id].asistio" />
                        ¿Asistió?
                    </label>

                    <div class="grid-2">
                        <label>
                            Progreso
                            <input type="number" min="0" max="10"
                                [(ngModel)]="tmp[s.id].progreso" />
                        </label>

                        <label>
                            Colaboración
                            <input type="number" min="0" max="10"
                                [(ngModel)]="tmp[s.id].colaboracion" />
                        </label>
                    </div>

                    <label class="full">
                        Observaciones
                        <textarea
                            [(ngModel)]="tmp[s.id].observaciones"></textarea>
                    </label>

                    <div class="row-actions">
                        <button class="btn-primary"
                            (click)="guardarEditar(s)">Guardar cambios</button>
                        <button class="btn-outline"
                            (click)="cancelarEditar(s.id)">Cancelar</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
