<!-- src/app/terapeuta/inicio/inicio.html -->

<div class="dashboard-terapeuta-wrapper">

  <!-- ================== HEADER ================== -->
  @if (dashboard()) {
    @let data = dashboard()!;

    <header class="dashboard-header-tea">
      <!-- Título del módulo y fecha -->
      <div class="header-top-bar">
        <div class="module-title">
          <mat-icon class="tea-icon">psychology</mat-icon>
          <div class="title-text">
            <h1>Módulo Terapeuta</h1>
            <p class="subtitle-tea">Centro TEA</p>
          </div>
        </div>

        <div class="header-actions">
          <div class="date-badge">
            <mat-icon>event</mat-icon>
            <span>{{ data.terapeuta.fechaHoy }}</span>
          </div>
          
          <button class="icon-btn notifications" (click)="abrirNotificaciones()">
            <mat-icon>notifications</mat-icon>
            @if (notificaciones().length > 0) {
              <span class="notification-badge">{{ notificaciones().length }}</span>
            }
          </button>
          
          <button class="icon-btn messages" (click)="abrirMensajes()">
            <mat-icon>mail</mat-icon>
          </button>
        </div>
      </div>

      <!-- Bienvenida personalizada y búsqueda -->
      <div class="header-main-section">
        <div class="welcome-section">
          <div class="avatar-circle">
            <span>{{ data.terapeuta.nombre.charAt(0) }}</span>
          </div>
          
          <div class="welcome-text">
            <p class="greeting">¡Bienvenida!</p>
            <h2 class="therapist-name">{{ data.terapeuta.nombre }}</h2>
            <p class="role-badge">
              <mat-icon>medical_services</mat-icon>
              {{ data.terapeuta.especialidad }}
            </p>
          </div>
        </div>

        <!-- Barra de búsqueda global -->
        <div class="global-search">
          <mat-icon>search</mat-icon>
          <input 
            type="text" 
            placeholder="Buscar niños, sesiones, reportes o mensajes..." 
            [(ngModel)]="searchQuery"
            (input)="onSearch($event)"
          />
        </div>
      </div>
    </header>
  }

  <!-- ================== ESTADO DE CARGA / ERROR ================== -->
  @if (cargando()) {
    <div class="status-box info">
      <mat-icon>hourglass_empty</mat-icon>
      <span>Cargando tu día de trabajo...</span>
    </div>
  }

  @if (error()) {
    <div class="status-box error">
      <mat-icon>error_outline</mat-icon>
      <span>{{ error() }}</span>
    </div>
  }

  <!-- ================== TARJETAS KPI ================== -->
  @if (!cargando() && dashboard()) {
    @let data = dashboard()!;
    
    <section class="kpi-cards-section">
      <div class="kpi-card blue">
        <div class="kpi-icon">
          <mat-icon>today</mat-icon>
        </div>
        <div class="kpi-content">
          <p class="kpi-label">Sesiones de hoy</p>
          <h3 class="kpi-value">{{ data.resumen.sesionesHoy }}</h3>
          <p class="kpi-description">Programadas</p>
        </div>
      </div>

      <div class="kpi-card pink">
        <div class="kpi-icon">
          <mat-icon>face</mat-icon>
        </div>
        <div class="kpi-content">
          <p class="kpi-label">Niños asignados</p>
          <h3 class="kpi-value">{{ ninosAsignadosHoy().length }}</h3>
          <p class="kpi-description">Activos</p>
        </div>
      </div>

      <div class="kpi-card yellow">
        <div class="kpi-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <div class="kpi-content">
          <p class="kpi-label">Asistencia mensual</p>
          <h3 class="kpi-value">{{ calcularTasaAsistencia() }}%</h3>
          <p class="kpi-description">Confirmadas</p>
        </div>
      </div>

      <div class="kpi-card purple">
        <div class="kpi-icon">
          <mat-icon>assignment</mat-icon>
        </div>
        <div class="kpi-content">
          <p class="kpi-label">Reportes pendientes</p>
          <h3 class="kpi-value">{{ data.resumen.tareasPendientes || 0 }}</h3>
          <p class="kpi-description">Cuatrimestrales</p>
        </div>
      </div>
    </section>

    <!-- ================== ALERTAS VISIBLES ================== -->
    @if (tieneAlertasImportantes()) {
      <section class="alertas-importantes">
        @if (data.resumen.tareasPendientes > 0) {
          <div class="alerta warning">
            <mat-icon>warning</mat-icon>
            <div class="alerta-content">
              <p class="alerta-title">Reportes cuatrimestrales pendientes</p>
              <p class="alerta-text">Tienes {{ data.resumen.tareasPendientes }} reporte(s) por entregar.</p>
            </div>
            <button class="btn-alerta" (click)="irAReportes()">Ver reportes</button>
          </div>
        }
        
        @if (tieneAsistenciasSinRegistrar()) {
          <div class="alerta danger">
            <mat-icon>event_busy</mat-icon>
            <div class="alerta-content">
              <p class="alerta-title">Asistencias sin registrar</p>
              <p class="alerta-text">Hay sesiones con asistencia pendiente de confirmar.</p>
            </div>
            <button class="btn-alerta" (click)="irAAsistencias()">Registrar ahora</button>
          </div>
        }
      </section>
    }

  <!-- ================== GRID PRINCIPAL ================== -->
    <div class="dashboard-grid">

      <!-- 2️⃣ Próximas sesiones del día -->
      <section class="card sesiones-card">
        <div class="card-header">
          <h2>Sesiones de hoy</h2>
          <span class="pill">
            {{ sesionesDelDia().length }} agendadas
          </span>
        </div>

        @if (sesionesDelDia().length === 0) {
          <p class="empty-text">Hoy no tienes sesiones programadas.</p>
        } @else {
          <div class="sesiones-list">
            @for (sesion of sesionesDelDia(); track sesion.id_sesion) {
              <article class="sesion-item">
                <div class="sesion-time">
                  <span class="hora">{{ sesion.hora_inicio }} — {{ sesion.hora_fin }}</span>
                  <span class="sala">Sala {{ sesion.sala }}</span>
                </div>

                <div class="sesion-main">
                  <div class="foto-nino" *ngIf="sesion.fotografia; else noFoto">
                    <img [src]="sesion.fotografia!" [alt]="sesion.nombre_nino">
                  </div>
                  <ng-template #noFoto>
                    <div class="foto-placeholder"><mat-icon>person</mat-icon></div>
                  </ng-template>

                  <div class="sesion-info">
                    <h3>{{ sesion.nombre_nino }}</h3>
                    <p class="terapia">
                      {{ sesion.terapia }}
                      @if (sesion.es_reposicion) {
                        <span class="tag warning">
                          <mat-icon>history</mat-icon> Reposición
                        </span>
                      }
                    </p>

                    <div class="sesion-flags">
                      @if (sesion.tiene_retraso) {
                        <span class="flag danger">
                          <mat-icon>schedule</mat-icon> Retraso registrado
                        </span>
                      }
                      @if (sesion.nota_importante) {
                        <span class="flag note">
                          <mat-icon>sticky_note_2</mat-icon> Nota previa
                        </span>
                      }
                    </div>

                    @if (sesion.nota_importante) {
                      <p class="nota-importante">{{ sesion.nota_importante }}</p>
                    }
                  </div>
                </div>
              </article>
            }
          </div>
        }
      </section>

      <!-- 3️⃣ Niños asignados hoy -->
      <section class="card ninos-card">
        <div class="card-header">
          <div class="header-title">
            <mat-icon>face</mat-icon>
            <h2>Mis niños asignados</h2>
          </div>
          <span class="pill">{{ ninosAsignadosHoy().length }} niño(s)</span>
        </div>

        @if (ninosAsignadosHoy().length === 0) {
          <div class="empty-state">
            <mat-icon>sentiment_satisfied</mat-icon>
            <p>Aún no hay niños asignados para hoy.</p>
          </div>
        } @else {
          <div class="ninos-grid">
            @for (nino of ninosAsignadosHoy(); track nino.id_nino) {
              <article class="nino-card-tea">
                
                <!-- Cabecera con foto y datos básicos -->
                <div class="nino-header">
                  <div class="nino-foto" *ngIf="nino.fotografia; else noFotoNino">
                    <img [src]="nino.fotografia!" [alt]="nino.nombre">
                  </div>
                  <ng-template #noFotoNino>
                    <div class="nino-foto placeholder">
                      <mat-icon>person</mat-icon>
                    </div>
                  </ng-template>

                  <div class="nino-info-basica">
                    <h3>{{ nino.nombre }}</h3>
                    <div class="nino-meta">
                      <span class="edad">
                        <mat-icon>cake</mat-icon>
                        {{ nino.edad || 'N/A' }} años
                      </span>
                      <span class="diagnostico" [class.nivel-1]="nino.nivelTEA === 1" 
                                                [class.nivel-2]="nino.nivelTEA === 2"
                                                [class.nivel-3]="nino.nivelTEA === 3">
                        <mat-icon>favorite</mat-icon>
                        TEA Nivel {{ nino.nivelTEA || 'N/A' }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Información clínica -->
                <div class="nino-clinica">
                  <div class="info-row">
                    <span class="label">Terapia principal:</span>
                    <span class="value">{{ nino.terapiaPrincipal }}</span>
                  </div>
                  <div class="info-row">
                    <span class="label">Cuatrimestre actual:</span>
                    <span class="value badge-cuatrimestre">{{ nino.cuatrimestreActual || 'N/A' }}</span>
                  </div>
                  <div class="info-row">
                    <span class="label">Última sesión:</span>
                    <span class="value">{{ nino.ultimaSesion || 'Sin registros' }}</span>
                  </div>
                  <div class="info-row">
                    <span class="label">Total de sesiones:</span>
                    <span class="value"><strong>{{ nino.totalSesiones || 0 }}</strong></span>
                  </div>
                </div>

                <!-- Indicadores de progreso -->
                <div class="nino-indicadores">
                  <p class="indicadores-title">Indicadores de progreso</p>
                  <div class="indicador">
                    <span>Conducta</span>
                    <div class="barra">
                      <div class="relleno" [style.width.%]="nino.indicadores.conducta"></div>
                    </div>
                    <span class="porcentaje">{{ nino.indicadores.conducta }}%</span>
                  </div>
                  <div class="indicador">
                    <span>Comunicación</span>
                    <div class="barra">
                      <div class="relleno" [style.width.%]="nino.indicadores.comunicacion"></div>
                    </div>
                    <span class="porcentaje">{{ nino.indicadores.comunicacion }}%</span>
                  </div>
                  <div class="indicador">
                    <span>Sensorial</span>
                    <div class="barra">
                      <div class="relleno" [style.width.%]="nino.indicadores.sensorial"></div>
                    </div>
                    <span class="porcentaje">{{ nino.indicadores.sensorial }}%</span>
                  </div>
                </div>

                <!-- Acciones rápidas -->
                <div class="nino-acciones">
                  <button class="btn-accion primary" (click)="verExpediente(nino.id_nino)">
                    <mat-icon>folder_open</mat-icon>
                    Ver expediente
                  </button>
                  <button class="btn-accion secondary" (click)="verHistorial(nino.id_nino)">
                    <mat-icon>history</mat-icon>
                    Historial
                  </button>
                  <button class="btn-accion accent" (click)="registrarSesion(nino.id_nino)">
                    <mat-icon>note_add</mat-icon>
                    Registrar sesión
                  </button>
                </div>

              </article>
            }
          </div>
        }
      </section>

      <!-- 4️⃣ Notificaciones -->
      <section class="card notificaciones-card">
        <div class="card-header"><h2>Notificaciones</h2></div>

        @if (notificaciones().length === 0) {
          <p class="empty-text">No tienes notificaciones nuevas.</p>
        } @else {
          <ul class="notificaciones-list">
            @for (notif of notificaciones(); track notif.fecha + notif.mensaje) {
              <li class="notif-item">
                <div class="notif-icon">
                  <mat-icon>{{ getTipoNotificacionIcono(notif.tipo) }}</mat-icon>
                </div>
                <div class="notif-text">
                  <p>{{ notif.mensaje }}</p>
                  <span class="notif-fecha">{{ notif.fecha }}</span>
                </div>
              </li>
            }
          </ul>
        }
      </section>

      <!-- 5️⃣ Tareas, estadísticas, accesos rápidos -->
      <section class="card tareas-card">
        <div class="card-header"><h2>Recursos y tareas pendientes</h2></div>

        @if (tareasPendientes().length === 0) {
          <p class="empty-text">No tienes tareas pendientes por ahora.</p>
        } @else {
          <ul class="tareas-list">
            @for (tarea of tareasPendientes(); track tarea.recurso) {
              <li class="tarea-item">
                <div class="tarea-main">
                  <h3>{{ tarea.recurso }}</h3>
                  <p>{{ tarea.totalAsignados }} asignado(s) · {{ tarea.completados }} completado(s)</p>
                </div>
                <div class="tarea-progreso">
                  <div class="progreso-barra">
                    <div class="progreso-relleno" [style.width.%]="getProgresoPorcentaje(tarea.completados, tarea.totalAsignados)"></div>
                  </div>
                  <span class="progreso-label">{{ getProgresoPorcentaje(tarea.completados, tarea.totalAsignados) }}%</span>
                </div>
              </li>
            }
          </ul>
        }

        @if (estadisticas()) {
          @let stats = estadisticas()!;

          <div class="stats-grid">
            <div class="stat-box">
              <p class="stat-label">Sesiones esta semana</p>
              <p class="stat-value">{{ stats.totalSesiones }}</p>
            </div>

            <div class="stat-box">
              <p class="stat-label">Asistencias completadas</p>
              <p class="stat-value">{{ stats.asistenciasCompletadas }}</p>
            </div>

            <div class="stat-box">
              <p class="stat-label">Cancelaciones</p>
              <p class="stat-value">{{ stats.cancelaciones }}</p>
            </div>

            <div class="stat-box">
              <p class="stat-label">Reposiciones pendientes</p>
              <p class="stat-value">{{ stats.reposicionesPendientes }}</p>
            </div>

            @if (stats.satisfaccionPromedio !== undefined) {
              <div class="stat-box full">
                <p class="stat-label">Satisfacción promedio del tutor</p>
                <p class="stat-value">{{ stats.satisfaccionPromedio }}/5</p>
              </div>
            }
          </div>
        }

        <div class="quick-actions">
          <button type="button" (click)="registrarNotaInmediata()">
            <mat-icon>note_add</mat-icon> Registrar nota inmediata
          </button>
          <button type="button" (click)="agregarReposicion()">
            <mat-icon>history</mat-icon> Agregar reposición
          </button>
          <button type="button" (click)="enviarRecurso()">
            <mat-icon>send</mat-icon> Enviar recurso
          </button>
          <button type="button" (click)="verPacientes()">
            <mat-icon>face</mat-icon> Ver pacientes
          </button>
          <button type="button" (click)="verHorarios()">
            <mat-icon>event</mat-icon> Ver horarios
          </button>
        </div>

      </section>

    </div>
  }

</div>

<!-- Modal de Registro de Sesión -->
@if (mostrarModalRegistro()) {
  <app-registro-sesion-modal
    [ninoId]="ninoSeleccionadoId()!"
    [ninoNombre]="ninoSeleccionadoNombre()"
    (cerrar)="cerrarModalRegistro()"
    (sesionRegistrada)="onSesionRegistrada($event)"
  />
}
