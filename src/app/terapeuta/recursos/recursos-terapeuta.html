<div class="recursos-terapeuta-container">
  <header class="page-header">
    <div class="header-content">
      <div>
        <h1>Gesti√≥n de Recursos</h1>
        <p class="subtitulo">Crea y administra material educativo para las
          familias</p>
      </div>
      <button class="btn-nuevo" (click)="abrirFormulario()">
        <span>‚ûï</span> Nuevo Recurso
      </button>
    </div>

    <div class="estadisticas">
      <div class="stat-card">
        <span class="stat-icono">üìö</span>
        <div>
          <p class="stat-valor">{{ recursosTotal() }}</p>
          <p class="stat-label">Total Recursos</p>
        </div>
      </div>

      @for (categoria of recursosPorCategoria() | keyvalue; track categoria.key)
      {
      <div class="stat-card mini" [class]="getColorCategoria(categoria.key)">
        <p class="stat-valor">{{ categoria.value }}</p>
        <p class="stat-label">{{ categoria.key }}</p>
      </div>
      }
    </div>
  </header>

  @if (error()) {
  <div class="alerta-error">
    <span>‚ö†Ô∏è</span>
    <p>{{ error() }}</p>
    <button (click)="error.set(null)">‚úï</button>
  </div>
  }

  @if (cargando()) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Cargando recursos...</p>
  </div>
  } @else if (recursos().length === 0) {
  <div class="empty-state">
    <span class="empty-icono">üìö</span>
    <h3>No hay recursos creados</h3>
    <p>Comienza creando tu primer recurso para compartir con las familias</p>
    <button class="btn-primario" (click)="abrirFormulario()">
      Crear Primer Recurso
    </button>
  </div>
  } @else {
  <div class="recursos-grid">
    @for (recurso of recursos(); track recurso.id) {
    <article class="recurso-card">
      <div class="card-header">
        <span class="tipo-badge" [class]="recurso.tipo_recurso.toLowerCase()">
          {{ getIconoTipo(recurso.tipo_recurso) }}
          {{ recurso.tipo_recurso }}
        </span>
        <div class="card-acciones">
          <button class="btn-icon" (click)="verRecurso(recurso)" title="Ver">
            üëÅÔ∏è
          </button>
          @if (recurso.tipo_recurso === 'PDF') {
          <button class="btn-icon" (click)="descargarRecurso(recurso)"
            title="Descargar">
            ‚¨áÔ∏è
          </button>
          }
          <button class="btn-icon eliminar"
            (click)="eliminarRecurso(recurso.id)" title="Eliminar">
            üóëÔ∏è
          </button>
        </div>
      </div>

      <h3 class="recurso-titulo">{{ recurso.titulo }}</h3>
      <p class="recurso-descripcion">{{ recurso.descripcion }}</p>

      <div class="recurso-meta">
        <span class="badge"
          [class]="getColorCategoria(recurso.categoria_recurso)">
          {{ recurso.categoria_recurso }}
        </span>
        <span class="badge gris">{{ recurso.nivel_recurso }}</span>
      </div>

      <div class="objetivo-box">
        <strong>Objetivo:</strong>
        <p>{{ recurso.objetivo_terapeutico }}</p>
      </div>

      <div class="card-footer">
        <span class="fecha">
          üìÖ {{ recurso.fecha_creacion | date: 'dd/MM/yyyy' }}
        </span>
        @if (recurso.asignaciones > 0) {
        <span class="asignaciones">
          üë• {{ recurso.asignaciones }} asignado(s)
        </span>
        }
      </div>
    </article>
    }
  </div>
  }

  <!-- MODAL FORMULARIO -->
  @if (mostrarFormulario()) {
  <div class="modal-overlay" (click)="cerrarFormulario()">
    <div class="modal-contenido" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h2>{{ modoEdicion() ? 'Editar' : 'Nuevo' }} Recurso</h2>
        <button class="btn-cerrar" (click)="cerrarFormulario()">‚úï</button>
      </header>

      <form [formGroup]="formulario" (ngSubmit)="guardarRecurso()"
        class="recurso-form">
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Recurso *</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" formControlName="tipo_recurso" value="PDF">
                <span>üìÑ PDF</span>
              </label>
              <label class="radio-label">
                <input type="radio" formControlName="tipo_recurso"
                  value="VIDEO">
                <span>üé• Video</span>
              </label>
              <label class="radio-label">
                <input type="radio" formControlName="tipo_recurso"
                  value="ENLACE">
                <span>üîó Enlace</span>
              </label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="titulo">T√≠tulo *</label>
          <input
            id="titulo"
            type="text"
            formControlName="titulo"
            placeholder="Ej: Gu√≠a de comunicaci√≥n b√°sica"
            [class.invalido]="campoInvalido('titulo')">
          @if (campoInvalido('titulo')) {
          <span class="error-msg">{{ getMensajeError('titulo') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="descripcion">Descripci√≥n *</label>
          <textarea
            id="descripcion"
            formControlName="descripcion"
            rows="4"
            placeholder="Describe el contenido y objetivo del recurso..."
            [class.invalido]="campoInvalido('descripcion')"></textarea>
          @if (campoInvalido('descripcion')) {
          <span class="error-msg">{{ getMensajeError('descripcion') }}</span>
          }
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="categoria">Categor√≠a *</label>
            <select
              id="categoria"
              formControlName="categoria_recurso"
              [class.invalido]="campoInvalido('categoria_recurso')">
              <option value>Seleccionar...</option>
              @for (categoria of categorias; track categoria) {
              <option [value]="categoria">{{ categoria }}</option>
              }
            </select>
            @if (campoInvalido('categoria_recurso')) {
            <span class="error-msg">{{ getMensajeError('categoria_recurso')
              }}</span>
            }
          </div>

          <div class="form-group">
            <label for="nivel">Nivel *</label>
            <select
              id="nivel"
              formControlName="nivel_recurso"
              [class.invalido]="campoInvalido('nivel_recurso')">
              <option value>Seleccionar...</option>
              @for (nivel of niveles; track nivel) {
              <option [value]="nivel">{{ nivel }}</option>
              }
            </select>
            @if (campoInvalido('nivel_recurso')) {
            <span class="error-msg">{{ getMensajeError('nivel_recurso')
              }}</span>
            }
          </div>
        </div>

        <div class="form-group">
          <label for="objetivo">Objetivo Terap√©utico *</label>
          <textarea
            id="objetivo"
            formControlName="objetivo_terapeutico"
            rows="3"
            placeholder="¬øQu√© se espera lograr con este recurso?"
            [class.invalido]="campoInvalido('objetivo_terapeutico')"></textarea>
          @if (campoInvalido('objetivo_terapeutico')) {
          <span class="error-msg">{{ getMensajeError('objetivo_terapeutico')
            }}</span>
          }
        </div>

        <div class="form-group">
          <label for="hijo">Asignar a Hijo/Paciente *</label>
          <select
            id="hijo"
            formControlName="hijo_id"
            [class.invalido]="campoInvalido('hijo_id')">
            <option value>Seleccionar...</option>
            @if (cargandoHijos()) {
            <option disabled>Cargando...</option>
            } @else {
            @for (hijo of hijos(); track hijo.id) {
            <option [value]="hijo.id">
              {{ hijo.nombre }} {{ hijo.apellido }} - {{ hijo.edad }} a√±os
              (Padre: {{ hijo.padre_nombre }})
            </option>
            }
            }
          </select>
          @if (campoInvalido('hijo_id')) {
          <span class="error-msg">{{ getMensajeError('hijo_id') }}</span>
          }
        </div>

        @if (formulario.value.tipo_recurso === 'PDF') {
        <div class="form-group">
          <label>Archivo PDF *</label>
          <div class="file-upload">
            <input
              type="file"
              id="archivo"
              accept=".pdf"
              (change)="seleccionarArchivo($event)"
              #fileInput>
            <label for="archivo" class="file-label">
              <span>üìé</span>
              @if (archivoSeleccionado()) {
              <span>{{ archivoSeleccionado()!.name }}</span>
              } @else {
              <span>Seleccionar archivo PDF</span>
              }
            </label>
          </div>
          @if (previsualizacionArchivo()) {
          <div class="preview-pdf">
            <span>‚úÖ Archivo listo para subir</span>
          </div>
          }
        </div>
        }

        @if (formulario.value.tipo_recurso === 'VIDEO' ||
        formulario.value.tipo_recurso === 'ENLACE') {
        <div class="form-group">
          <label for="url">URL *</label>
          <input
            id="url"
            type="url"
            formControlName="url"
            placeholder="https://..."
            [class.invalido]="campoInvalido('url')">
          @if (campoInvalido('url')) {
          <span class="error-msg">{{ getMensajeError('url') }}</span>
          }
        </div>
        }

        <div class="form-actions">
          <button type="button" class="btn-cancelar"
            (click)="cerrarFormulario()">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-guardar"
            [disabled]="formulario.invalid || subiendoArchivo()">
            @if (subiendoArchivo()) {
            <span class="spinner-small"></span>
            Subiendo...
            } @else {
            üíæ Guardar Recurso
            }
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>
