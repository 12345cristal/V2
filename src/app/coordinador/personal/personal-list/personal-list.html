<div class="personal-wrapper">

  <!-- HEADER SUPERIOR -->
  <header class="page-header">
    <div class="page-title">
      <h1>Gesti√≥n de Personal</h1>
      <p>Administra el equipo terap√©utico y personal del centro</p>
    </div>

    <div class="header-actions">
      <button class="btn-secondary" (click)="abrirModalVacaciones()" title="Aplicar vacaciones a personal activo">
        <mat-icon>beach_access</mat-icon>
        <span>Vacaciones Masivas</span>
      </button>
      <button class="btn-primary" (click)="agregar()">
        <mat-icon>person_add</mat-icon>
        <span>Agregar Personal</span>
      </button>
    </div>
  </header>

  <!-- STATS -->
  <section class="stats">
    <article class="stat-card stat-blue">
      <div class="stat-icon">
        <mat-icon>groups</mat-icon>
      </div>
      <div>
        <p class="stat-label">Total Personal</p>
        <p class="stat-value">{{ totalPersonal() }}</p>
      </div>
    </article>

    <article class="stat-card stat-purple">
      <div class="stat-icon">
        <mat-icon>psychology</mat-icon>
      </div>
      <div>
        <p class="stat-label">Terapeutas</p>
        <p class="stat-value">{{ totalTeraputas() }}</p>
      </div>
    </article>

    <article class="stat-card stat-green">
      <div class="stat-icon">
        <mat-icon>task_alt</mat-icon>
      </div>
      <div>
        <p class="stat-label">Personal Activo</p>
        <p class="stat-value">{{ personalActivo() }}</p>
      </div>
    </article>

    <article class="stat-card stat-gold">
      <div class="stat-icon">
        <mat-icon>star_rate</mat-icon>
      </div>
      <div>
        <p class="stat-label">Calificaci√≥n Promedio</p>
        <p class="stat-value">{{ ratingPromedio() }}</p>
      </div>
    </article>

    <article class="stat-card stat-orange">
      <div class="stat-icon">
        <mat-icon>beach_access</mat-icon>
      </div>
      <div>
        <p class="stat-label">De Vacaciones</p>
        <p class="stat-value">{{ personalVacaciones() }}</p>
      </div>
    </article>

    <article class="stat-card stat-gray">
      <div class="stat-icon">
        <mat-icon>pause_circle</mat-icon>
      </div>
      <div>
        <p class="stat-label">Inactivos</p>
        <p class="stat-value">{{ personalInactivo() }}</p>
      </div>
    </article>
  </section>

  <!-- BUSCADOR Y FILTROS -->
  <section class="filters-row">
    <div class="search-box">
      <mat-icon>search</mat-icon>
      <input
        type="text"
        placeholder="Buscar por nombre o especialidad..."
        (input)="onBuscar($any($event.target).value)" />
    </div>

    <div class="role-filter">
      <label>Rol</label>
      <select (change)="onFiltrarRol($any($event.target).value)">
        <option value="all">Todos los roles</option>
        @for (rol of roles(); track rol.id_rol) {
          <option [value]="rol.id_rol">{{ rol.nombre_rol }}</option>
        }
      </select>
    </div>

    <div class="estado-filter">
      <label>Estado</label>
      <select (change)="onFiltrarEstado($any($event.target).value)">
        <option value="all">Todos los estados</option>
        <option value="ACTIVO">‚úì Activo</option>
        <option value="VACACIONES">üå¥ Vacaciones</option>
        <option value="INACTIVO">‚è∏ Inactivo</option>
      </select>
    </div>
  </section>

  <!-- TABS -->
  <nav class="view-tabs">
    <button
      (click)="cambiarVista('tarjetas')"
      [class.active]="vistaActual() === 'tarjetas'">
      <mat-icon>view_module</mat-icon>
      <span>Vista de Tarjetas</span>
    </button>

    <button
      (click)="cambiarVista('tabla')"
      [class.active]="vistaActual() === 'tabla'">
      <mat-icon>view_list</mat-icon>
      <span>Vista de Tabla</span>
    </button>
  </nav>

  <!-- MENSAJES DE ESTADO -->
  @if (cargando()) {
    <div class="state-message">
      <mat-icon>hourglass_top</mat-icon>
      <span>Cargando personal...</span>
    </div>
  }

  @if (!cargando() && errorCarga()) {
    <div class="state-message error">
      <mat-icon>error_outline</mat-icon>
      <span>{{ errorCarga() }}</span>
    </div>
  }

  @if (!cargando() && !errorCarga() && !personalFiltrado().length) {
    <div class="state-message">
      <mat-icon>search_off</mat-icon>
      <span>No hay resultados con los filtros actuales.</span>
    </div>
  }

  <!-- VISTA TARJETAS -->
  @if (!cargando() && !errorCarga() && personalFiltrado().length && vistaActual() === 'tarjetas') {
    <section class="cards-grid">
      @for (p of personalFiltrado(); track p.id_personal) {
        <article class="personal-card" (click)="abrirDetalle(p)">
          <header class="card-header">
            <div class="avatar">
              <span>{{ p.nombres.charAt(0) }}{{ p.apellido_paterno.charAt(0) }}</span>
            </div>

            <div class="card-title">
              <h3>{{ p.nombres }} {{ p.apellido_paterno }} {{ p.apellido_materno }}</h3>
              <p class="card-rol">
                <mat-icon class="rol-icon">{{
                  p.id_rol === 1 ? 'shield_admin' :
                  p.id_rol === 2 ? 'manage_accounts' :
                  'psychology'
                }}</mat-icon>
                {{ obtenerNombreRol(p.id_rol) }}
              </p>

              <span class="badge"
                    [class.badge-green]="p.estado_laboral === 'ACTIVO'"
                    [class.badge-orange]="p.estado_laboral === 'VACACIONES'"
                    [class.badge-gray]="p.estado_laboral === 'INACTIVO'">
                {{ p.estado_laboral }}
              </span>
            </div>

            <div class="dropdown" (click)="$event.stopPropagation()">
              <button class="icon-btn">
                <mat-icon>more_vert</mat-icon>
              </button>
              <div class="dropdown-menu">
                <button class="dropdown-item" (click)="editar(p)">
                  <mat-icon>edit</mat-icon>
                  <span>Editar</span>
                </button>
                <button class="dropdown-item" *ngIf="puedeActivar(p)" (click)="cambiarEstado(p, 'ACTIVO')">
                  <mat-icon>check_circle</mat-icon>
                  <span>Activar</span>
                </button>
                <button class="dropdown-item warning" *ngIf="puedePonerVacaciones(p)" (click)="cambiarEstado(p, 'VACACIONES')">
                  <mat-icon>beach_access</mat-icon>
                  <span>Vacaciones</span>
                </button>
                <button class="dropdown-item danger" *ngIf="puedeInactivar(p)" (click)="cambiarEstado(p, 'INACTIVO')">
                  <mat-icon>block</mat-icon>
                  <span>Inactivar</span>
                </button>
              </div>
            </div>
          </header>

          <div class="card-body">
            <p class="specialty">{{ p.especialidad_principal }}</p>

            <div class="card-meta">
              <div>
                <mat-icon>event_note</mat-icon>
                <span>Desde {{ p.fecha_ingreso | date:'dd MMM yyyy' }}</span>
              </div>
            </div>

            <div class="card-metrics">
              <div>
                <span class="metric-label">Pacientes</span>
                <span class="metric-value">{{ p.total_pacientes ?? '-' }}</span>
              </div>
              <div>
                <span class="metric-label">Sesiones/Sem</span>
                <span class="metric-value">{{ p.sesiones_semana ?? '-' }}</span>
              </div>
            </div>
          </div>

          <footer class="card-footer">
            <div class="rating">
              <mat-icon>star</mat-icon>
              <span>{{ p.rating ?? '-' }}</span>
            </div>
            <div class="card-actions">
              <button class="icon-btn" (click)="$event.stopPropagation(); abrirDetalle(p)">
                <mat-icon>visibility</mat-icon>
              </button>
            </div>
          </footer>

        </article>
      }
    </section>
  }

  <!-- VISTA TABLA -->
  @if (!cargando() && !errorCarga() && personalFiltrado().length && vistaActual() === 'tabla') {
    <section class="table-wrapper">
      <table class="personal-table">
        <thead>
          <tr>
            <th>Personal</th>
            <th>Rol</th>
            <th>Especialidad</th>
            <th>Contacto</th>
            <th>Desde</th>
            <th>Estado</th>
            <th>Pacientes</th>
            <th>Rating</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>

          @for (p of personalFiltrado(); track p.id_personal) {
            <tr>

              <td class="col-personal">
                <div class="avatar small">
                  <span>{{ p.nombres.charAt(0) }}{{ p.apellido_paterno.charAt(0) }}</span>
                </div>

                <div>
                  <p class="name">{{ p.nombres }} {{ p.apellido_paterno }}</p>
                  <p class="rol-small">{{ obtenerNombreRol(p.id_rol) }}</p>
                </div>
              </td>

              <td>
                <span class="rol-badge">
                  <mat-icon class="rol-icon">{{
                    p.id_rol === 1 ? 'shield_admin' :
                    p.id_rol === 2 ? 'manage_accounts' :
                    'psychology'
                  }}</mat-icon>
                  {{ obtenerNombreRol(p.id_rol) }}
                </span>
              </td>
              <td>{{ p.especialidad_principal }}</td>

              <td>
                <p>{{ p.correo_personal }}</p>
                <p>{{ p.telefono_personal }}</p>
              </td>

              <td>
                <span class="fecha-ingreso">{{ p.fecha_ingreso | date:'dd/MMM/yyyy' }}</span>
              </td>

              <td>
                <span class="badge"
                      [class.badge-green]="p.estado_laboral === 'ACTIVO'"
                      [class.badge-orange]="p.estado_laboral === 'VACACIONES'"
                      [class.badge-gray]="p.estado_laboral === 'INACTIVO'">
                  {{ p.estado_laboral }}
                </span>
              </td>

              <td>{{ p.total_pacientes ?? '-' }}</td>

              <td>
                <div class="rating small">
                  <mat-icon>star</mat-icon>
                  <span>{{ p.rating ?? '-' }}</span>
                </div>
              </td>

              <td class="actions">
                <button class="icon-btn" (click)="abrirDetalle(p)">
                  <mat-icon>visibility</mat-icon>
                </button>
                
                <div class="dropdown">
                  <button class="icon-btn">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <div class="dropdown-menu">
                    <button class="dropdown-item" (click)="editar(p)">
                      <mat-icon>edit</mat-icon>
                      <span>Editar</span>
                    </button>
                    <button class="dropdown-item" *ngIf="puedeActivar(p)" (click)="cambiarEstado(p, 'ACTIVO')">
                      <mat-icon>check_circle</mat-icon>
                      <span>Activar</span>
                    </button>
                    <button class="dropdown-item warning" *ngIf="puedePonerVacaciones(p)" (click)="cambiarEstado(p, 'VACACIONES')">
                      <mat-icon>beach_access</mat-icon>
                      <span>Vacaciones</span>
                    </button>
                    <button class="dropdown-item danger" *ngIf="puedeInactivar(p)" (click)="cambiarEstado(p, 'INACTIVO')">
                      <mat-icon>block</mat-icon>
                      <span>Inactivar</span>
                    </button>
                  </div>
                </div>
              </td>

            </tr>
          }

        </tbody>
      </table>
    </section>
  }

  <!-- MODAL VACACIONES MASIVAS -->
  @if (mostrarModalVacaciones()) {
    <div class="modal-overlay" (click)="cerrarModalVacaciones()">
      <div class="modal" (click)="$event.stopPropagation()">
        <header class="modal-header">
          <h2>Solicitar Vacaciones Masivas</h2>
          <button class="close-btn" (click)="cerrarModalVacaciones()">
            <mat-icon>close</mat-icon>
          </button>
        </header>

        <div class="modal-body">
          <p class="modal-info">
            Selecciona el per√≠odo de vacaciones para todo el personal activo
          </p>

          <div class="form-group">
            <label>Fecha de Inicio</label>
            <input
              type="date"
              [value]="dateInicio()"
              (change)="dateInicio.set($any($event.target).value)"
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label>Fecha de Fin</label>
            <input
              type="date"
              [value]="dateFin()"
              (change)="dateFin.set($any($event.target).value)"
              class="form-input"
            />
          </div>

          <div class="form-group">
            <p class="info-text">
              Se aplicar√°n vacaciones a <strong>{{ personalActivo() }}</strong> personal activo
            </p>
          </div>
        </div>

        <footer class="modal-footer">
          <button class="btn-outline" (click)="cerrarModalVacaciones()">
            Cancelar
          </button>
          <button class="btn-primary" (click)="aplicarVacacionesMasivas()">
            <mat-icon>beach_access</mat-icon>
            Aplicar Vacaciones
          </button>
        </footer>
      </div>
    </div>
  }

</div>
