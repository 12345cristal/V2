<div class="usuarios-wrapper">

  <!-- =========================== -->
  <!-- HEADER -->
  <!-- =========================== -->
  <header class="page-header">
    <div>
      <h1>Gestión de usuarios del sistema</h1>
      <p class="subtitle">
        Control de padres, terapeutas y personal · creación, edición y activación/inactivación
      </p>
    </div>

    <button type="button" class="btn-primary" (click)="nuevoUsuario()">
      <mat-icon>person_add</mat-icon>
      <span>Nuevo usuario</span>
    </button>
  </header>

  <!-- =========================== -->
  <!-- ALERTAS GLOBALES -->
  <!-- =========================== -->

  @if (errorGeneral) {
    <div class="alert alert-error" (click)="resetMensajes()">
      <mat-icon>error</mat-icon>
      <span>{{ errorGeneral }}</span>
    </div>
  }

  @if (mensajeOk) {
    <div class="alert alert-success" (click)="resetMensajes()">
      <mat-icon>check_circle</mat-icon>
      <span>{{ mensajeOk }}</span>
    </div>
  }

  <!-- =========================== -->
  <!-- LISTADOS -->
  <!-- =========================== -->

  <div class="layout-grid">
    
    <!-- ===================================== -->
    <!-- PERSONAL SIN USUARIO -->
    <!-- ===================================== -->

    <section class="card">
      <header class="card-header">
        <h2>Personal sin usuario</h2>

        @if (!cargandoPersonal) {
          <span class="badge">
            {{ personalSinUsuario.length }} sin asignar
          </span>
        }
      </header>

      @if (cargandoPersonal) {

        <div class="loading">Cargando personal…</div>

      } @else {

        @if (personalSinUsuario.length === 0) {

          <div class="empty">
            <mat-icon>done_all</mat-icon>
            <p>Todo el personal tiene usuario asignado.</p>
          </div>

        } @else {

          <ul class="list-personal">

            @for (p of personalSinUsuario; track p.id_personal) {
              <li (click)="asignarDesdePersonal(p)">
                
                <div class="info">
                  <h3>
                    {{ p.nombres }} {{ p.apellido_paterno }}
                    @if (p.apellido_materno) {
                      <span>{{ p.apellido_materno }}</span>
                    }
                  </h3>

                  <p>
                    {{ p.especialidad_principal }} ·
                    Ingreso {{ p.fecha_ingreso | date:'dd/MM/yyyy' }}
                  </p>
                </div>

                <button
                  type="button"
                  class="btn-link"
                  (click)="asignarDesdePersonal(p); $event.stopPropagation()">
                  <mat-icon>login</mat-icon>
                  Asignar usuario
                </button>

              </li>
            }

          </ul>

        }

      }

    </section>

    <!-- ===================================== -->
    <!-- USUARIOS DEL SISTEMA -->
    <!-- ===================================== -->

    <section class="card">

      <header class="card-header">
        <div class="titles">
          <h2>Usuarios del sistema</h2>
          <p>Revisa, filtra y administra las cuentas existentes.</p>
        </div>

        <div class="search-box">
          <mat-icon>search</mat-icon>
          <input
            type="text"
            formControlName="filtroTexto"
            (input)="aplicarFiltro()"
            placeholder="Buscar por usuario, nombre o rol…"
          />
        </div>
      </header>

      @if (cargandoUsuarios) {

        <div class="loading">Cargando usuarios…</div>

      } @else {

        @if (usuariosFiltrados.length === 0) {

          <div class="empty">
            <mat-icon>person_off</mat-icon>
            <p>No hay usuarios registrados o no coincide con el filtro.</p>
          </div>

        } @else {

          <div class="table-wrapper">

            <table class="usuarios-table">

              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Nombre</th>
                  <th>Rol del sistema</th>
                  <th>Estado</th>
                  <th>Último acceso</th>
                  <th class="col-actions">Acciones</th>
                </tr>
              </thead>

              <tbody>

                @for (u of usuariosFiltrados; track u.id_usuario) {
                  <tr>

                    <td class="col-username">@{{ u.username }}</td>

                    <td>
                      <div class="col-name">
                        <span class="name">{{ u.nombre_completo }}</span>

                        @if (u.nombre_rol_personal) {
                          <small>({{ u.nombre_rol_personal }})</small>
                        }
                      </div>
                    </td>

                    <td>
                      <span class="pill pill-role">{{ u.rol_sistema }}</span>
                    </td>

                    <td>
                      <span class="pill"
                        [ngClass]="{
                          'pill-active': u.estado === 'ACTIVO',
                          'pill-inactive': u.estado === 'INACTIVO',
                          'pill-blocked': u.estado === 'BLOQUEADO'
                        }">
                        {{ u.estado }}
                      </span>
                    </td>

                    <td>
                      @if (u.ultima_sesion) {
                        <small>{{ u.ultima_sesion | date:'dd/MM/yyyy HH:mm' }}</small>
                      } @else {
                        <small>Nunca</small>
                      }
                    </td>

                    <td class="col-actions">
                      <button type="button" class="icon-btn" (click)="editarUsuario(u)">
                        <mat-icon>edit</mat-icon>
                      </button>

                      <button type="button" class="icon-btn"
                        (click)="cambiarEstado(u)"
                        [title]="u.estado === 'ACTIVO' ? 'Inhabilitar' : 'Habilitar'">
                        
                        @if (u.estado === 'ACTIVO') {
                          <mat-icon>lock_open</mat-icon>
                        } @else {
                          <mat-icon>lock</mat-icon>
                        }
                        
                      </button>

                    </td>

                  </tr>
                }

              </tbody>

            </table>

          </div>

        }

      }

    </section>

  </div>

  <!-- ===================================== -->
  <!-- FORMULARIO -->
  <!-- ===================================== -->

  <section class="card form-card">

    <header class="card-header">
      <div>
        @if (!modoEdicion) {
          <h2>Crear nuevo usuario</h2>
        } @else {
          <h2>Editar usuario</h2>
        }

        <p class="subtitle">
          Llena los datos obligatorios. Se mostrará una advertencia si falta algún campo
          o la contraseña no cumple las reglas.
        </p>
      </div>
    </header>

    <form [formGroup]="formUsuario" (ngSubmit)="guardarUsuario()" novalidate>

      <div class="form-grid">

        <!-- PERSONAL -->
        <div class="form-group">
          <label for="id_personal">Personal asociado *</label>

          <select id="id_personal" formControlName="id_personal">

            <option [ngValue]="null">Selecciona una persona…</option>

            @for (p of personalSinUsuario; track p.id_personal) {
              <option [ngValue]="p.id_personal">
                {{ p.nombres }} {{ p.apellido_paterno }}
                @if (p.apellido_materno) {
                  {{ p.apellido_materno }}
                }
                · {{ p.especialidad_principal }}
              </option>
            }

          </select>

          @if (mostrarErrores && f['id_personal'].invalid) {
            <small class="error">
              Debes seleccionar a la persona a la que pertenece el usuario.
            </small>
          }
        </div>

        <!-- USERNAME -->
        <div class="form-group">
          <label for="username">Nombre de usuario *</label>

          <div class="input-prefix">
            <span>@</span>
            <input
              id="username"
              type="text"
              formControlName="username"
              autocomplete="off"
              placeholder="ej: juan.perez"
            />
          </div>

          <small class="hint">
            Solo letras, números y . _ -
          </small>

          @if (mostrarErrores && f['username'].errors?.['required']) {
            <small class="error">El nombre de usuario es obligatorio.</small>
          }

          @if (mostrarErrores && f['username'].errors?.['minlength']) {
            <small class="error">Debe tener al menos 4 caracteres.</small>
          }

          @if (mostrarErrores && f['username'].errors?.['pattern']) {
            <small class="error">Formato inválido.</small>
          }
        </div>

        <!-- ROL -->
        <div class="form-group">
          <label for="rol_sistema">Rol en el sistema *</label>

          <select id="rol_sistema" formControlName="rol_sistema">
            <option value="">Selecciona un rol…</option>
            <option value="COORDINADOR">Coordinador</option>
            <option value="TERAPEUTA">Terapeuta</option>
            <option value="RECEPCIONISTA">Recepcionista</option>
            <option value="PADRE">Padre / Tutor</option>
            <option value="ADMINISTRADOR">Administrador</option>
          </select>

          @if (mostrarErrores && f['rol_sistema'].invalid) {
            <small class="error">El rol es obligatorio.</small>
          }
        </div>

        <!-- ESTADO -->
        <div class="form-group">
          <label for="estado">Estado *</label>

          <select id="estado" formControlName="estado">
            <option value="ACTIVO">ACTIVO</option>
            <option value="INACTIVO">INACTIVO</option>
            <option value="BLOQUEADO">BLOQUEADO</option>
          </select>
        </div>

      </div>

      <div class="divider"></div>

      <!-- ===================================== -->
      <!-- SECCIÓN CONTRASEÑA -->
      <!-- ===================================== -->

      <div class="password-section">

        <div class="password-header">
          <h3>Contraseña</h3>
          <p class="subtitle">Validación automática de reglas de seguridad.</p>
        </div>

        <div class="password-grid">

          @if (modoEdicion) {
            <div class="form-group">
              <label class="checkbox">
                <input type="checkbox" formControlName="cambiarPassword" />
                <span>Cambiar contraseña</span>
              </label>

              <small class="hint">
                Marca esta opción si deseas actualizar la contraseña del usuario.
              </small>
            </div>
          }

          <div class="form-group">
            <label class="checkbox">
              <input type="checkbox" formControlName="debe_cambiar_password" />
              <span>Obligar a cambiar contraseña al iniciar sesión</span>
            </label>
          </div>

        </div>

        <!-- CAMPOS DE CONTRASEÑA -->
        <div class="password-grid">

          <!-- PASSWORD -->
          <div class="form-group">
            <label for="password">
              Contraseña
              @if (!modoEdicion || f['cambiarPassword'].value) {
                <span>*</span>
              }
            </label>

            <input
              id="password"
              type="password"
              formControlName="password"
              autocomplete="new-password"
              placeholder="Mín. 8 caracteres, símbolo, mayúscula, número"
            />

           @if (passwordControl?.value) {
  <div class="password-rules">

    <span [class.ok]="reglasPassword.length">
      • 8 caracteres
    </span>

    <span [class.ok]="reglasPassword.mayus">
      • Mayúscula
    </span>

    <span [class.ok]="reglasPassword.minus">
      • Minúscula
    </span>

    <span [class.ok]="reglasPassword.numero">
      • Número
    </span>

    <span [class.ok]="reglasPassword.simbolo">
      • Símbolo
    </span>

  </div>
}


            @if (mostrarErrores && passwordControl?.errors?.['required']) {
              <small class="error">Obligatorio.</small>
            }
            @if (mostrarErrores && passwordControl?.errors?.['pattern']) {
              <small class="error">Formato inseguro.</small>
            }
          </div>

          <!-- CONFIRMAR PASSWORD -->
          <div class="form-group">
            <label for="confirmarPassword">
              Confirmar contraseña
              @if (!modoEdicion || f['cambiarPassword'].value) {
                <span>*</span>
              }
            </label>

            <input
              id="confirmarPassword"
              type="password"
              formControlName="confirmarPassword"
              autocomplete="new-password"
              placeholder="Repetir contraseña"
            />

            @if (mostrarErrores && confirmarPasswordControl?.errors?.['required']) {
              <small class="error">Campo obligatorio.</small>
            }

            @if (mostrarErrores && confirmarPasswordControl?.errors?.['passwordMismatch']) {
              <small class="error">No coinciden.</small>
            }

          </div>

        </div>

      </div>

      <!-- ===================================== -->
      <!-- BOTONES -->
      <!-- ===================================== -->

      <div class="form-actions">
        <button type="submit" class="btn-primary">
          <mat-icon>save</mat-icon>
          <span>{{ modoEdicion ? 'Guardar cambios' : 'Crear usuario' }}</span>
        </button>

        <button type="button" class="btn-ghost" (click)="nuevoUsuario()">
          <mat-icon>refresh</mat-icon>
          <span>Limpiar formulario</span>
        </button>
      </div>

      <p class="note">
        * Se mostrará una advertencia si falta un campo obligatorio o la contraseña no cumple las reglas.
      </p>

    </form>
  </section>

</div>
