<div class="usuario-form-wrapper">

  <header class="top-bar">
    <button class="back-btn" (click)="salirAlListado()">
      <mat-icon>arrow_back</mat-icon>
      <span>Volver</span>
    </button>

    <h1>{{ modoEdicion ? 'Editar usuario' : 'Crear nuevo usuario' }}</h1>
  </header>

  <section class="card form-card">

    <p class="form-subtitle">
      Completa todos los campos obligatorios.
    </p>

    <form [formGroup]="form" (ngSubmit)="guardarUsuario()" novalidate>

      <h2 class="section-title">Datos principales</h2>

      <div class="form-grid">

        <!-- PERSONAL -->
        <div class="form-group">
          <label>Personal *</label>
          <select formControlName="id_personal">
            <option [ngValue]="null">Selecciona...</option>

            @for (p of personalSinUsuario; track p.id_personal) {
              <option [value]="p.id_personal">
                {{ p.nombres }} {{ p.apellido_paterno }} {{ p.apellido_materno }}
              </option>
            }
          </select>

          @if (mostrarErrores && f['id_personal'].invalid) {
            <small class="error">Debes seleccionar un personal.</small>
          }
        </div>

          <!-- EMAIL -->
          <div class="form-group">
            <label>Correo *</label>
            <input type="email" formControlName="email" placeholder="correo@dominio.com" />

            @if (mostrarErrores && f['email'].invalid) {
              <small class="error">Correo requerido o inválido.</small>
            }
          </div>

        <!-- ROL -->
        <div class="form-group">
          <label>Rol *</label>

            <select formControlName="rol_id">
            <option value="">Selecciona...</option>

            @for (r of rolesSistema; track r.id_rol) {
                <option [value]="r.id_rol">{{ r.nombre_rol }}</option>
            }
          </select>

            @if (mostrarErrores && f['rol_id'].invalid) {
            <small class="error">Debes seleccionar un rol.</small>
          }
        </div>

        <!-- ESTADO DESDE BD -->
        <div class="form-group">
          <label>Estado *</label>

          <select formControlName="estado">
            @for (estado of estadosSistema; track estado) {
              <option [value]="estado">{{ estado }}</option>
            }
          </select>
        </div>

      </div>

      <div class="divider"></div>

      <!-- CONTRASEÑA -->
      <h2 class="section-title">Contraseña</h2>

      <div class="password-options">

        @if (modoEdicion) {
          <label class="checkbox">
            <input type="checkbox" formControlName="cambiarPassword" />
            <span>Cambiar contraseña</span>
          </label>
        }

      </div>

      <div class="form-grid">

        <!-- PASSWORD -->
        <div class="form-group">
          <label>Contraseña *</label>

          <input type="password" formControlName="password" />

          @if (passwordControl?.value) {
            <div class="password-rules">
              <span [class.ok]="reglasPassword.length">• 8 caracteres</span>
              <span [class.ok]="reglasPassword.mayus">• Mayúscula</span>
              <span [class.ok]="reglasPassword.minus">• Minúscula</span>
              <span [class.ok]="reglasPassword.numero">• Número</span>
              <span [class.ok]="reglasPassword.simbolo">• Símbolo</span>
            </div>
          }
        </div>

        <!-- CONFIRMAR -->
        <div class="form-group">
          <label>Confirmar *</label>

          <input type="password" formControlName="confirmarPassword" />

          @if (mostrarErrores && confirmarPasswordControl?.errors?.['passwordMismatch']) {
            <small class="error">No coinciden.</small>
          }
        </div>

      </div>

      <!-- ACCIONES -->
      <div class="form-actions">

        <button type="submit" class="btn-primary">
          <mat-icon>save</mat-icon>
          {{ modoEdicion ? 'Guardar cambios' : 'Crear usuario' }}
        </button>

        <button type="button" class="btn-secondary" (click)="limpiarFormulario()">
          <mat-icon>refresh</mat-icon>
          Limpiar
        </button>

        <button type="button" class="btn-ghost" (click)="salirAlListado()">
          <mat-icon>close</mat-icon>
          Salir
        </button>

      </div>

    </form>
  </section>

</div>
