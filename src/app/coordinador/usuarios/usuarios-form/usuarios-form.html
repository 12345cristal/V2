<div class="modal-overlay" (click)="onCancelar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modoEdicion ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
      <button type="button" class="btn-close" (click)="onCancelar()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form [formGroup]="formUsuario" (ngSubmit)="onGuardar()">
      <div class="form-body">

        @if (!modoEdicion) {
        <div class="form-group">
          <label>Personal *</label>
          <select formControlName="id_personal">
            <option [value]="null">Seleccione personal</option>
            @for (p of personalSinUsuario; track p.id_personal) {
            <option [value]="p.id_personal">
              {{ p.nombres }} {{ p.apellido_paterno }} {{ p.apellido_materno ||
              '' }}
            </option>
            }
          </select>
          @if (mostrarErrores && formUsuario.get('id_personal')?.invalid) {
          <span class="error-mensaje">Campo requerido</span>
          }
        </div>
        }

        <div class="form-group">
          <label>Email *</label>
          <input type="email" formControlName="email"
            placeholder="correo@ejemplo.com" />
          @if (mostrarErrores && formUsuario.get('email')?.invalid) {
          <span class="error-mensaje">Email válido requerido</span>
          }
        </div>

        <div class="form-group">
          <label>Rol *</label>
          <select formControlName="rol_id">
            <option [value]="null">Seleccione rol</option>
            @for (rol of rolesSistema; track rol.id_rol) {
            <option [value]="rol.id_rol">{{ rol.nombre_rol }}</option>
            }
          </select>
          @if (mostrarErrores && formUsuario.get('rol_id')?.invalid) {
          <span class="error-mensaje">Campo requerido</span>
          }
        </div>

        @if (modoEdicion) {
        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" formControlName="cambiarPassword" />
            Cambiar contraseña
          </label>
        </div>
        }

        @if (!modoEdicion || cambiarPassword) {
        <div class="form-group">
          <label>Contraseña *</label>
          <input type="password" formControlName="password"
            autocomplete="new-password" />
          @if (mostrarErrores && formUsuario.get('password')?.invalid) {
          <span class="error-mensaje">Mínimo 8 caracteres</span>
          }
        </div>

        <div class="form-group">
          <label>Confirmar Contraseña *</label>
          <input type="password" formControlName="confirmarPassword"
            autocomplete="new-password" />
          @if (mostrarErrores && formUsuario.errors?.['passwordsMismatch']) {
          <span class="error-mensaje">Las contraseñas no coinciden</span>
          }
        </div>
        }

        <div class="form-group">
          <label>Estado</label>
          <select formControlName="estado">
            <option value="ACTIVO">Activo</option>
            <option value="INACTIVO">Inactivo</option>
          </select>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancelar" (click)="onCancelar()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        <button type="submit" class="btn-guardar">
          <mat-icon>{{ modoEdicion ? 'save' : 'add' }}</mat-icon>
          {{ modoEdicion ? 'Actualizar' : 'Crear' }}
        </button>
      </div>
    </form>
  </div>
</div>
