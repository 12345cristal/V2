<div class="citas-wrapper">

  <!-- HEADER -->
  <header class="citas-header">
    <div>
      <h1>Gestión de Citas</h1>
      <p class="subtitle">Administra las citas programadas con niños y terapeutas</p>
    </div>

    <button type="button" class="btn-outline" (click)="nuevaCita()">
      <mat-icon>add</mat-icon>
      Nueva cita
    </button>
  </header>


  <!-- =========================== -->
  <!-- MODAL DE REGISTRO / EDICIÓN -->
  <!-- =========================== -->

  @if (mostrarModal()) {

    <!-- FONDO OSCURO -->
    <div class="modal-backdrop" (click)="cerrarModal()"></div>

    <!-- MODAL -->
    <div class="modal">

      <div class="modal-header">
        <h2>
          @if (citaEnEdicion) { Editar cita } 
          @else { Nueva cita }
        </h2>

        <button class="modal-close" (click)="cerrarModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <form [formGroup]="form" (ngSubmit)="enviarFormulario()" class="modal-body">

        <!-- ID NIÑO -->
        <div class="form-field">
          <label>ID Niño *</label>
          <input type="number" formControlName="nino_id" placeholder="ID del niño">
        </div>

        <!-- ID TERAPEUTA -->
        <div class="form-field">
          <label>ID Terapeuta *</label>
          <input type="number" formControlName="terapeuta_id" placeholder="ID del terapeuta">
        </div>

        <!-- ID TERAPIA -->
        <div class="form-field">
          <label>ID Terapia *</label>
          <input type="number" formControlName="terapia_id" placeholder="ID de la terapia">
        </div>

        <!-- FECHA -->
        <div class="form-field">
          <label>Fecha *</label>
          <input type="date" formControlName="fecha">
        </div>

        <!-- HORA INICIO -->
        <div class="form-field">
          <label>Hora de inicio *</label>
          <input type="time" formControlName="hora_inicio">
        </div>

        <!-- HORA FIN -->
        <div class="form-field">
          <label>Hora de fin *</label>
          <input type="time" formControlName="hora_fin">
        </div>

        <!-- ESTADO -->
        <div class="form-field">
          <label>Estado</label>
          <select formControlName="estado_id">
            @for (e of estadosCita; track e.id) {
              <option [ngValue]="e.id">{{ e.nombre }}</option>
            }
          </select>
        </div>

        <!-- REPOSICIÓN -->
        <div class="form-field form-field-inline">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="es_reposicion" [value]="1">
            <span>Es reposición</span>
          </label>
        </div>

        <!-- MOTIVO -->
        <div class="form-field form-field-full">
          <label>Motivo</label>
          <textarea rows="2" formControlName="motivo" placeholder="Motivo de la cita"></textarea>
        </div>

        <!-- OBSERVACIONES -->
        <div class="form-field form-field-full">
          <label>Observaciones</label>
          <textarea rows="3" formControlName="observaciones" placeholder="Observaciones adicionales"></textarea>
        </div>

        <button class="btn-primary" type="submit" [disabled]="guardando() || form.invalid">
          @if (guardando()) { Guardando... }
          @else { @if (citaEnEdicion) { Actualizar cita } @else { Guardar cita } }
        </button>

      </form>

    </div> <!-- modal -->

  } <!-- /modal -->


  <!-- =========================== -->
  <!-- LISTADO DE CITAS -->
  <!-- =========================== -->

  <section class="card card-list">

    <div class="card-header list-header">
      <div>
        <h2>Citas registradas ({{ totalCitas }})</h2>
        <p>Filtra por fecha, estado o busca por nombre.</p>
      </div>

      <div class="filters">

        <div class="filter-item">
          <label>Fecha</label>
          <input type="date" [(ngModel)]="filtroFecha" (change)="aplicarFiltros()">
        </div>

        <div class="filter-item">
          <label>Estado</label>
          <select [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
            <option value="">Todos</option>
            @for (e of estadosCita; track e.id) {
              <option [ngValue]="e.id">{{ e.nombre }}</option>
            }
          </select>
        </div>

        <div class="filter-item">
          <label>Buscar</label>
          <input type="text" [(ngModel)]="filtroBuscar" placeholder="Buscar niño..." (keyup.enter)="aplicarFiltros()">
        </div>

        <button type="button" class="btn-text" (click)="limpiarFiltros()">
          <mat-icon>clear</mat-icon>
          Limpiar
        </button>

      </div>
    </div>


    <!-- LOADING -->
    @if (cargandoCitas()) {
      <div class="table-loading">
        <div class="spinner"></div>
        <p>Cargando citas...</p>
      </div>
    } @else {

      <!-- SI HAY CITAS -->
      @if (citas.length > 0) {

        <div class="table-responsive">
          <table class="citas-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Niño</th>
                <th>Terapeuta</th>
                <th>Terapia</th>
                <th>Estado</th>
                <th>Reposición</th>
                <th>Acciones</th>
              </tr>
            </thead>

            <tbody>
              @for (c of citas; track c.id_cita) {
                <tr>
                  <td>{{ c.id_cita }}</td>
                  <td>{{ c.fecha }}</td>
                  <td>{{ c.hora_inicio }} - {{ c.hora_fin }}</td>
                  <td>{{ c.nino_nombre || 'N/A' }}</td>
                  <td>{{ c.terapeuta_nombre || 'N/A' }}</td>
                  <td>{{ c.terapia_nombre || 'N/A' }}</td>

                  <td>
                    <span class="badge" [class]="getEstadoClase(c.estado_id)">
                      {{ getEstadoNombre(c.estado_id) }}
                    </span>
                  </td>

                  <td>
                    @if (c.es_reposicion === 1) {
                      <span class="tag tag-reposicion">Sí</span>
                    } @else {
                      <span class="tag">No</span>
                    }
                  </td>

                  <td class="actions">
                    <button class="icon-button" (click)="editarCita(c)" title="Editar">
                      <mat-icon>edit</mat-icon>
                    </button>

                    <button class="icon-button" (click)="cambiarEstado(c, 3)" title="Cancelar" [disabled]="c.estado_id === 3">
                      <mat-icon>close</mat-icon>
                    </button>

                    <button class="icon-button danger" (click)="eliminarCita(c)" title="Eliminar">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>

          </table>
        </div>

      } @else {

        <!-- SI NO HAY CITAS -->
        <div class="empty-state">
          <mat-icon>event_busy</mat-icon>
          <p>No hay citas registradas.</p>
        </div>

      }

      <!-- PAGINACIÓN -->
      @if (totalPaginas > 1) {
        <div class="pagination">
          <button 
            class="btn-pagination" 
            (click)="cambiarPagina(paginaActual - 1)" 
            [disabled]="paginaActual === 1">
            <mat-icon>chevron_left</mat-icon>
            Anterior
          </button>

          <span class="pagination-info">
            Página {{ paginaActual }} de {{ totalPaginas }} ({{ totalCitas }} citas)
          </span>

          <button 
            class="btn-pagination" 
            (click)="cambiarPagina(paginaActual + 1)" 
            [disabled]="paginaActual === totalPaginas">
            Siguiente
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      }

    } <!-- fin else cargando -->

  </section>

</div>
