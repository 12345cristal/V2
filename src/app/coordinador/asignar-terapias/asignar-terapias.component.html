<!-- ========================================
     CALENDARIO SEMANAL - ESTILO GOOGLE CALENDAR
     ======================================== -->
<div class="calendar-container">

  <!-- BARRA SUPERIOR -->
  <header class="calendar-header">
    <div class="header-left">
      <h1 class="calendar-title">Calendario de Terapias</h1>
    </div>

    <div class="header-center">
      <button class="btn-today" (click)="irHoy()">Hoy</button>
      <div class="nav-buttons">
        <button class="btn-icon" (click)="semanaSiguiente(-1)">
          <span class="material-icons">chevron_left</span>
        </button>
        <button class="btn-icon" (click)="semanaSiguiente(1)">
          <span class="material-icons">chevron_right</span>
        </button>
      </div>
      <h2 class="current-period">{{ obtenerTituloPeriodo() }}</h2>
    </div>

    <div class="header-right">
      <select class="view-selector" [(ngModel)]="vistaActual" (ngModelChange)="cambiarVista($event)">
        <option value="semana">Semana</option>
        <option value="dia">Día</option>
        <option value="mes">Mes</option>
      </select>
      <button class="btn-primary" (click)="abrirModalNuevaTerapia()">
        <span class="material-icons">add</span>
        Nueva Terapia
      </button>
    </div>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="calendar-body">

    <!-- SIDEBAR IZQUIERDO -->
    <aside class="calendar-sidebar">
      
      <!-- MINI CALENDARIO -->
      <div class="mini-calendar">
        <div class="mini-calendar-header">
          <button class="btn-icon-sm" (click)="cambiarMesMini(-1)">
            <span class="material-icons">chevron_left</span>
          </button>
          <span class="mini-month">{{ obtenerMesMini() }}</span>
          <button class="btn-icon-sm" (click)="cambiarMesMini(1)">
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
        <div class="mini-calendar-grid">
          @for (dia of diasSemanaCortos; track $index) {
            <div class="mini-day-name">{{ dia }}</div>
          }
          @for (dia of diasMiniCalendario; track $index) {
            <div class="mini-day"
                 [class.other-month]="!dia.mesActual"
                 [class.today]="dia.esHoy"
                 [class.selected]="dia.seleccionado"
                 (click)="seleccionarDiaMini(dia)">
              {{ dia.numero }}
            </div>
          }
        </div>
      </div>

      <!-- FILTROS -->
      <div class="filters-section">
        <h3 class="filters-title">Filtra antes de ver</h3>

        <div class="filter-group">
          <label class="filter-label">Niño</label>
          <select class="filter-input" [(ngModel)]="filtroNinoId">
            <option [ngValue]="null">Seleccionar niño...</option>
            @for (nino of ninos; track $index) {
              <option [ngValue]="nino.id">{{ obtenerNombreCompleto(nino) }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Terapeuta</label>
          <select class="filter-input" [(ngModel)]="filtroTerapeutaId">
            <option [ngValue]="null">Seleccionar terapeuta...</option>
            @for (terapeuta of terapeutas; track $index) {
              <option [ngValue]="terapeuta.id">{{ obtenerNombreCompleto(terapeuta) }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Terapia</label>
          <select class="filter-input" [(ngModel)]="filtroTerapiaId">
            <option [ngValue]="null">Seleccionar terapia...</option>
            @for (terapia of terapias; track $index) {
              <option [ngValue]="terapia.id">{{ terapia.nombre }}</option>
            }
          </select>
        </div>

        <div class="filter-group compact-row">
          <label class="filter-label">Estados visibles</label>
          <div class="filter-chips">
            <label class="filter-chip">
              <input type="checkbox" [(ngModel)]="mostrarProgramadas">
              <span class="status-dot programada"></span> Prog.
            </label>
            <label class="filter-chip">
              <input type="checkbox" [(ngModel)]="mostrarReprogramadas">
              <span class="status-dot reprogramada"></span> Reprog.
            </label>
            <label class="filter-chip">
              <input type="checkbox" [(ngModel)]="mostrarCanceladas">
              <span class="status-dot cancelada"></span> Canc.
            </label>
          </div>
        </div>

        <label class="switch-row">
          <input type="checkbox" [(ngModel)]="verTodo">
          <span>Ver todo (carga completa)</span>
        </label>

        <div class="filter-actions">
          <button class="btn-primary" (click)="aplicarFiltros()">Cargar semana</button>
          <button class="btn-secondary" (click)="limpiarFiltros()">Limpiar</button>
        </div>
      </div>
    </aside>

    <!-- ÁREA DEL CALENDARIO -->
    <main class="calendar-main">
      
      <!-- ALERTAS -->
      @if (mensajeExito || mensajeError) {
        <div class="alerts-container">
          @if (mensajeExito) {
            <div class="alert alert-success">
              <span class="material-icons">check_circle</span>
              <span>{{ mensajeExito }}</span>
              <button class="alert-close" (click)="mensajeExito = ''">×</button>
            </div>
          }
          @if (mensajeError) {
            <div class="alert alert-error">
              <span class="material-icons">error</span>
              <span>{{ mensajeError }}</span>
              <button class="alert-close" (click)="mensajeError = ''">×</button>
            </div>
          }
        </div>
      }

      @if (!verTodo && !filtroNinoId && !filtroTerapeutaId && !filtroTerapiaId) {
        <div class="empty-hint">
          <span class="material-icons">filter_list</span>
          <p>Selecciona niño, terapeuta o terapia y luego presiona "Cargar semana".</p>
        </div>
      }

      <!-- VISTA SEMANAL -->
      @if (vistaActual === 'semana') {
        <div class="week-view">
          
          <!-- ENCABEZADO DE DÍAS -->
          <div class="week-header">
            <div class="time-column-header">GMT-7</div>
            @for (dia of diasSemana; track $index) {
              <div class="day-header" [class.today]="dia.esHoy">
                <div class="day-name">{{ dia.nombre }}</div>
                <div class="day-number" [class.today-number]="dia.esHoy">{{ dia.numero }}</div>
              </div>
            }
          </div>

          <!-- CUADRÍCULA DE HORAS -->
          <div class="week-grid">
            
            <!-- COLUMNA DE HORAS -->
            <div class="time-column">
              @for (hora of horasDelDia; track $index) {
                <div class="time-slot">
                  <span class="time-label">{{ hora }}</span>
                </div>
              }
            </div>

            <!-- COLUMNAS DE DÍAS -->
            @for (dia of diasSemana; track $index) {
              <div class="day-column"
                   [class.today-column]="dia.esHoy"
                   (drop)="onDrop($event, dia)"
                   (dragover)="onDragOver($event)">
                
                <!-- LÍNEAS DE HORA -->
                @for (hora of horasDelDia; track $index) {
                  <div class="hour-line"></div>
                }

                <!-- EVENTOS/TERAPIAS -->
                @for (evento of obtenerEventosDia(dia.fecha); track $index) {
                  <div class="event-card"
                       [class.dragging]="evento.id === eventoDragging?.id"
                       [class.estado-programada]="evento.estado === 'programada'"
                       [class.estado-reprogramada]="evento.estado === 'reprogramada'"
                       [class.estado-cancelada]="evento.estado === 'cancelada'"
                       [style.top.px]="calcularPosicionTop(evento.horaInicio)"
                       [style.height.px]="calcularAltura(evento.horaInicio, evento.horaFin)"
                       draggable="true"
                       (dragstart)="onDragStart($event, evento)"
                       (dragend)="onDragEnd($event)"
                       (click)="abrirModalEditar(evento)">
                    
                    <div class="event-time">{{ evento.horaInicio }} - {{ evento.horaFin }}</div>
                    <div class="event-title">{{ evento.ninoNombre }}</div>
                    <div class="event-subtitle">{{ evento.terapiaNombre }}</div>
                    <div class="event-therapist">{{ evento.terapeutaNombre }}</div>
                    <div class="event-actions">
                      @if (evento.sincronizadoGoogle) {
                        <button class="chip" (click)="$event.stopPropagation(); abrirEnGoogle(evento)">
                          <span class="material-icons">link</span> Google
                        </button>
                      }
                    </div>
                    
                    <!-- RESIZE HANDLE -->
                    <div class="resize-handle" (mousedown)="onResizeStart($event, evento)"></div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }

      <!-- VISTA DÍA (placeholder) -->
      @if (vistaActual === 'dia') {
        <div class="day-view">
          <p class="text-center text-muted">Vista día (próximamente)</p>
        </div>
      }

      <!-- VISTA MES (placeholder) -->
      @if (vistaActual === 'mes') {
        <div class="month-view">
          <p class="text-center text-muted">Vista mes (próximamente)</p>
        </div>
      }

    </main>
  </div>

</div>

<!-- ========================================
     MODAL: NUEVA/EDITAR TERAPIA
     ======================================== -->
@if (modalAbierto) {
  <div class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="material-icons">{{ eventoEditando ? 'edit' : 'add' }}</span>
          {{ eventoEditando ? 'Editar Terapia' : 'Nueva Terapia' }}
        </h2>
        <button class="btn-icon" (click)="cerrarModal()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        
        <!-- SELECCIÓN DE NIÑO -->
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons">child_care</span>
            Niño *
          </label>
          <select class="form-control" [(ngModel)]="formularioEvento.ninoId">
            <option [ngValue]="null">Seleccionar niño...</option>
            @for (nino of ninos; track nino.id) {
              <option [ngValue]="nino.id">{{ obtenerNombreCompleto(nino) }}</option>
            }
          </select>
        </div>

        <!-- SELECCIÓN DE TERAPIA -->
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons">medical_services</span>
            Tipo de Terapia *
          </label>
          <select class="form-control"
                  [(ngModel)]="formularioEvento.terapiaId"
                  (ngModelChange)="onTerapiaChangeModal($event)">
            <option [ngValue]="null">Seleccionar terapia...</option>
            @for (terapia of terapias; track terapia.id) {
              <option [ngValue]="terapia.id">{{ terapia.nombre }} ({{ terapia.duracion_minutos }} min)</option>
            }
          </select>
        </div>

        <!-- SELECCIÓN DE TERAPEUTA -->
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons">badge</span>
            Terapeuta *
          </label>
          <select class="form-control"
                  [(ngModel)]="formularioEvento.terapeutaId"
                  [disabled]="!formularioEvento.terapiaId">
            <option [ngValue]="null">
              {{ formularioEvento.terapiaId ? 'Seleccionar terapeuta...' : 'Primero selecciona una terapia...' }}
            </option>
            @for (terapeuta of terapeutasFiltradosLista; track terapeuta.id) {
              <option [ngValue]="terapeuta.id">
                {{ obtenerNombreCompleto(terapeuta) }}{{ terapeuta.especialidad ? ' - ' + terapeuta.especialidad : '' }}
              </option>
            }
          </select>
        </div>

        <!-- FECHA Y HORA -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">calendar_today</span>
              Fecha *
            </label>
            <input type="date" class="form-control" [(ngModel)]="formularioEvento.fecha">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">schedule</span>
              Hora Inicio *
            </label>
            <input type="time" class="form-control" [(ngModel)]="formularioEvento.horaInicio">
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">schedule</span>
              Hora Fin *
            </label>
            <input type="time" class="form-control" [(ngModel)]="formularioEvento.horaFin" [readonly]="true">
          </div>
        </div>

        <!-- RECURRENCIA (solo para nuevo) -->
        @if (!eventoEditando) {
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="formularioEvento.esRecurrente">
              <span>Evento recurrente (repetir semanalmente)</span>
            </label>
          </div>
        }

        @if (formularioEvento.esRecurrente && !eventoEditando) {
          <div class="recurrence-options">
            <div class="form-group">
              <label class="form-label">Días de la semana</label>
              <div class="days-chips">
                @for (dia of opcionesDias; track dia.valor) {
                  <label class="day-chip">
                    <input type="checkbox" [(ngModel)]="dia.seleccionado">
                    <span>{{ dia.nombre }}</span>
                  </label>
                }
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Cantidad de semanas</label>
              <input type="number" class="form-control" [(ngModel)]="formularioEvento.cantidadSemanas" min="1" max="52">
            </div>
          </div>
        }

        <!-- OBSERVACIONES -->
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons">notes</span>
            Observaciones
          </label>
          <textarea class="form-control" rows="3" [(ngModel)]="formularioEvento.observaciones" placeholder="Notas adicionales..."></textarea>
        </div>

        <!-- SINCRONIZACIÓN GOOGLE -->
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="formularioEvento.sincronizarGoogle">
            <span class="material-icons sync-icon">sync</span>
            <span>Sincronizar con Google Calendar</span>
          </label>
        </div>

      </div>

      <div class="modal-footer">
        <!-- BOTÓN CANCELAR (si es edición) -->
        @if (eventoEditando) {
          <button class="btn-danger" (click)="cancelarTerapia()">
            <span class="material-icons">cancel</span>
            Cancelar Terapia
          </button>
        }

        <div class="modal-footer-right">
          <button class="btn-secondary" (click)="cerrarModal()">
            Cerrar
          </button>
          <button class="btn-primary" (click)="guardarEvento()" [disabled]="!formularioValido()">
            <span class="material-icons">{{ eventoEditando ? 'save' : 'add' }}</span>
            {{ eventoEditando ? 'Guardar Cambios' : 'Crear Terapia' }}
          </button>
        </div>
      </div>

    </div>
  </div>
}

<!-- LOADING OVERLAY -->
@if (cargando) {
  <div class="loading-overlay">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>
}
