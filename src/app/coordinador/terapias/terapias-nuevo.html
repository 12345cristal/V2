<div class="terapias-wrapper">

  <!-- HEADER -->
  <header class="page-header">
    <div class="page-title">
      <h1>Gestión de Terapias</h1>
      <p>Administra las terapias y asignaciones de terapeutas</p>
    </div>
    <button class="btn-primary" (click)="abrirCrear()">
      <mat-icon>add_circle</mat-icon>
      <span>Nueva Terapia</span>
    </button>
  </header>

  <!-- STATS -->
  <section class="stats">
    <article class="stat-card">
      <div class="stat-icon">
        <mat-icon>psychology</mat-icon>
      </div>
      <div>
        <p class="stat-label">Total de Terapias</p>
        <p class="stat-value">{{ terapias().length }}</p>
      </div>
    </article>

    <article class="stat-card">
      <div class="stat-icon">
        <mat-icon>person</mat-icon>
      </div>
      <div>
        <p class="stat-label">Personal Disponible</p>
        <p class="stat-value">{{ personalDisponible().length }}</p>
      </div>
    </article>

    <article class="stat-card">
      <div class="stat-icon">
        <mat-icon>person_check</mat-icon>
      </div>
      <div>
        <p class="stat-label">Personal Asignado</p>
        <p class="stat-value">{{ personalAsignado().length }}</p>
      </div>
    </article>
  </section>

  <!-- TERAPIAS -->
  <section class="terapias-section">
    <div class="section-header">
      <h2>
        <mat-icon>list</mat-icon>
        Catálogo de Terapias
      </h2>
    </div>

    <div class="terapias-grid">
      @for (t of terapias(); track t.id_terapia) {
        <article class="terapia-card">
          <header class="card-header">
            <div class="icon-badge">
              <mat-icon>psychology</mat-icon>
            </div>
            <h3>{{ t.nombre }}</h3>
          </header>

          <div class="card-body">
            <p class="description">{{ t.descripcion || 'Sin descripción' }}</p>
            
            <div class="card-footer">
              <span class="estado-badge" [class.activa]="t.estado === 'ACTIVA'">
                {{ t.estado }}
              </span>
              <div class="card-actions">
                <button class="icon-btn" (click)="abrirEditar(t)" title="Editar">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="icon-btn" (click)="cambiarEstado(t)" title="Cambiar estado">
                  <mat-icon>{{ t.estado === 'ACTIVA' ? 'toggle_on' : 'toggle_off' }}</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </article>
      }
    </div>
  </section>

  <!-- ASIGNACIÓN DE PERSONAL -->
  <section class="asignacion-section">
    
    <!-- PERSONAL DISPONIBLE -->
    <div class="personal-subsection">
      <div class="section-header">
        <h2>
          <mat-icon>person_outline</mat-icon>
          Personal Disponible
        </h2>
        <p class="section-hint">Sin especialidad asignada aún. Asigna una terapia específica.</p>
      </div>

      @if (personalDisponible().length === 0) {
        <div class="empty-state">
          <mat-icon>check_circle</mat-icon>
          <p>¡Todo el personal tiene una terapia asignada!</p>
        </div>
      } @else {
        <div class="personal-list">
          @for (p of personalDisponible(); track p.id_personal) {
            <div class="personal-item">
              <div class="personal-info">
                <div class="avatar">
                  <span>{{ (p.nombres || '').charAt(0) }}{{ (p.apellido_paterno || '').charAt(0) }}</span>
                </div>
                <div>
                  <h4>{{ p.nombres }} {{ p.apellido_paterno }} {{ p.apellido_materno || '' }}</h4>
                  <p class="role-tag">Sin especialidad</p>
                </div>
              </div>
              <select class="terapia-select" (change)="asignar(p.id_personal, toNumber($any($event.target).value))">
                <option value="" disabled selected>Asignar terapia...</option>
                @for (t of terapias(); track t.id_terapia) {
                  <option [value]="t.id_terapia">{{ t.nombre }}</option>
                }
              </select>
            </div>
          }
        </div>
      }
    </div>

    <!-- PERSONAL ASIGNADO CON FILTROS -->
    <div class="personal-subsection">
      <div class="section-header">
        <h2>
          <mat-icon>person_check</mat-icon>
          Personal Asignado ({{ personalAsignadoFiltrado().length }})
        </h2>
      </div>

      <!-- FILTROS -->
      <div class="filters-group">
        <div class="filter-item">
          <label>Buscar</label>
          <input 
            type="text" 
            placeholder="Nombre del terapeuta..."
            (input)="busqueda.set($any($event.target).value)"
          />
        </div>
        <div class="filter-item">
          <label>Sexo</label>
          <select (change)="filtroSexo.set($any($event.target).value)">
            <option value="todos">Todos</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
          </select>
        </div>
        <div class="filter-item">
          <label>Terapia</label>
          <select (change)="filtroTerapia.set($any($event.target).value === 'todos' ? 'todos' : +$any($event.target).value)">
            <option value="todos">Todas las terapias</option>
            @for (t of terapias(); track t.id_terapia) {
              <option [value]="t.id_terapia">{{ t.nombre }}</option>
            }
          </select>
        </div>
      </div>

      @if (personalAsignadoFiltrado().length === 0) {
        <div class="empty-state">
          <mat-icon>search_off</mat-icon>
          <p>No hay resultados para los filtros seleccionados</p>
        </div>
      } @else {
        <div class="personal-assigned-grid">
          @for (p of personalAsignadoFiltrado(); track p.id_personal) {
            <div class="personal-card">
              <div class="card-avatar">
                <span>{{ (p.nombres || '').charAt(0) }}{{ (p.apellido_paterno || '').charAt(0) }}</span>
              </div>
              <div class="card-content">
                <h3>{{ p.nombres }} {{ p.apellido_paterno }}</h3>
                <p class="terapia-name">
                  <mat-icon>psychology</mat-icon>
                  {{ p.terapia }}
                </p>
                <p class="info-text">{{ p.especialidad || 'Sin especialidad' }}</p>
              </div>
            </div>
          }
        </div>
      }
    </div>

  </section>

</div>

<!-- MODAL -->
@if (mostrarModal()) {
  <div class="modal-overlay" (click)="cerrarModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h2>{{ modoEdicion() ? 'Editar Terapia' : 'Nueva Terapia' }}</h2>
        <button class="close-btn" (click)="cerrarModal()">
          <mat-icon>close</mat-icon>
        </button>
      </header>

      <form [formGroup]="form()!" class="modal-body">
        <div class="form-group">
          <label>Nombre de la Terapia *</label>
          <input 
            type="text" 
            formControlName="nombre"
            placeholder="Ej: Terapia Ocupacional"
            [class.error]="form()?.get('nombre')?.invalid && form()?.get('nombre')?.touched"
          />
          @if (form()?.get('nombre')?.invalid && form()?.get('nombre')?.touched) {
            <small class="error-msg">El nombre es obligatorio</small>
          }
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea 
            formControlName="descripcion"
            placeholder="Describe brevemente en qué consiste esta terapia..."
            rows="4"
          ></textarea>
        </div>
      </form>

      <footer class="modal-footer">
        <button class="btn-secondary" (click)="cerrarModal()">
          Cancelar
        </button>
        <button class="btn-primary" (click)="guardar()" [disabled]="form()?.invalid">
          <mat-icon>{{ modoEdicion() ? 'update' : 'add' }}</mat-icon>
          {{ modoEdicion() ? 'Actualizar' : 'Crear' }}
        </button>
      </footer>
    </div>
  </div>
}
