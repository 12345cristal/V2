<div class="form-wrapper">

  <!-- =======================
       HEADER
  ======================== -->
  <header class="form-header">

    <div>
      @if (!isEdit) {
        <h1>Nuevo beneficiario</h1>
      } @else {
        <h1>Editar beneficiario</h1>
      }

      <p class="subtitle">
        Paso {{ step }} de 5 ·

        @switch (step) {
          @case (1) { Datos personales }
          @case (2) { Información médica }
          @case (3) { Información escolar }
          @case (4) { Padres y contactos }
          @case (5) { Información emocional y del centro }
        }
      </p>
    </div>

    <button class="btn-outline" type="button" (click)="cancelar()">
      Cancelar
    </button>
  </header>

  <!-- =======================
       STEPPER
  ======================== -->
  <div class="stepper">
    @for (s of [1,2,3,4,5]; track s) {
      <div class="step"
           [class.active]="s === step"
           [class.done]="s < step"
           (click)="goToStep(s)">
        <div class="bubble">{{ s }}</div>

        <span class="label">
          @switch (s) {
            @case (1) { Datos niño }
            @case (2) { Médico }
            @case (3) { Escolar }
            @case (4) { Familia }
            @case (5) { Centro }
          }
        </span>
      </div>
    }
  </div>

  <!-- ALERTA GLOBAL -->
  @if (submitError) {
    <div class="alert error">{{ submitError }}</div>
  }

  <form [formGroup]="formulario" class="nino-form" (ngSubmit)="guardar()">

    <!-- =====================================================
         PASO 1: DATOS PERSONALES
    ====================================================== -->
    @if (step === 1) {
    <section class="form-section">
      <h2>Datos personales del niño</h2>

      <div class="grid-3">
        <div class="field">
          <label>Nombre *</label>
          <input type="text" formControlName="nombre">
          @if (isInvalid('nombre')) {
            <small class="error">Ingresa un nombre válido.</small>
          }
        </div>

        <div class="field">
          <label>Apellido paterno *</label>
          <input type="text" formControlName="apellidoPaterno">
          @if (isInvalid('apellidoPaterno')) {
            <small class="error">Campo obligatorio.</small>
          }
        </div>

        <div class="field">
          <label>Apellido materno *</label>
          <input type="text" formControlName="apellidoMaterno">
          @if (isInvalid('apellidoMaterno')) {
            <small class="error">Campo obligatorio.</small>
          }
        </div>
      </div>

      <div class="grid-3">

        <div class="field">
          <label>Fecha de nacimiento *</label>
          <input type="date" formControlName="fechaNacimiento">
          @if (isInvalid('fechaNacimiento')) {
            <small class="error">Selecciona una fecha.</small>
          }
        </div>

        <div class="field">
          <label>Edad</label>
          <input type="number" formControlName="edad">
        </div>

        <div class="field">
          <label>Sexo *</label>
          <select formControlName="sexo">
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="O">Otro</option>
          </select>
          @if (isInvalid('sexo')) {
            <small class="error">Selecciona una opción.</small>
          }
        </div>

      </div>

      <div class="grid-2">
        <div class="field">
          <label>CURP</label>
          <input type="text" formControlName="curp">
        </div>
        <div class="field">
          <label>Tipo de sangre</label>
          <select formControlName="tipoSangre">
            <option value="">Seleccionar</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
          </select>
        </div>
      </div>
      
      <div class="grid-2">
        <div class="field">
          <label>Fotografía (opcional)</label>
          <input type="file" accept=".jpg,.jpeg,.png" (change)="onFileChange($event, 'foto')">
        </div>
      </div>

      <h3>Dirección</h3>
      <div class="grid-3" formGroupName="direccion">
        <div class="field"><label>Calle</label><input formControlName="calle"></div>
        <div class="field"><label>Número</label><input formControlName="numero"></div>
        <div class="field"><label>Colonia</label><input formControlName="colonia"></div>
        <div class="field"><label>Municipio</label><input formControlName="municipio"></div>
        <div class="field"><label>Código postal</label><input formControlName="codigoPostal"></div>
      </div>
    </section>
    }

    <!-- =====================================================
         PASO 2: INFORMACIÓN MÉDICA
    ====================================================== -->

    @if (step === 2) {
    <section class="form-section">
      <h2>Información médica</h2>

      <div formGroupName="diagnostico">
        <div class="grid-2">
          <div class="field">
            <label>Diagnóstico principal *</label>
            <input formControlName="diagnosticoPrincipal">
            @if (isInvalid('diagnostico.diagnosticoPrincipal')) {
              <small class="error">Campo obligatorio.</small>
            }
          </div>

          <div class="field">
            <label>Fecha del diagnóstico</label>
            <input type="date" formControlName="fechaDiagnostico">
          </div>
        </div>

        <div class="field">
          <label>Diagnósticos secundarios (coma)</label>
          <input
            [value]="diagnosticosSecundariosString"
            (input)="updateDiagnosticosSecundarios($event)">
        </div>

        <div class="grid-2">
          <div class="field">
            <label>Especialista</label>
            <input formControlName="especialista">
          </div>
          <div class="field">
            <label>Institución</label>
            <input formControlName="institucion">
          </div>
        </div>
      </div>

      <div class="field">
        <label>Subir diagnóstico (PDF / imagen)</label>
        <input type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileChange($event, 'diagnostico')">
      </div>

      <div formGroupName="alergias">
        <h3>Alergias</h3>
        <div class="grid-3">
          <div class="field"><label>Medicamentos</label><input formControlName="medicamentos"></div>
          <div class="field"><label>Alimentos</label><input formControlName="alimentos"></div>
          <div class="field"><label>Ambiental</label><input formControlName="ambiental"></div>
        </div>
      </div>

      <h3>Medicamentos actuales</h3>
      <div formArrayName="medicamentosActuales" class="meds-list">

        @for (med of medicamentosArray.controls; track med; let i = $index) {
          <div class="med-row" [formGroupName]="i">
            <div class="field">
              <label>Nombre *</label>
              <input formControlName="nombre">
              @if (med.get('nombre')?.invalid && med.get('nombre')?.touched) {
                <small class="error">Campo obligatorio.</small>
              }
            </div>

            <div class="field"><label>Dosis</label><input formControlName="dosis"></div>
            <div class="field"><label>Horario</label><input formControlName="horario"></div>

            <button type="button" class="link-danger" (click)="eliminarMedicamento(i)">Eliminar</button>
          </div>
        }

      </div>

      <button class="btn-outline small" type="button" (click)="agregarMedicamento()">+ Agregar medicamento</button>
    </section>
    }

    <!-- =====================================================
         PASO 3: ESCOLAR
    ====================================================== -->

    @if (step === 3) {
    <section class="form-section" formGroupName="escolar">
      <h2>Información escolar</h2>

      <div class="grid-2">
        <div class="field"><label>Escuela</label><input formControlName="escuela"></div>
        <div class="field"><label>Grado</label><input formControlName="grado"></div>
      </div>

      <div class="grid-2">
        <div class="field"><label>Maestro(a)</label><input formControlName="maestro"></div>
        <div class="field"><label>Horario</label><input formControlName="horarioClases"></div>
      </div>

      <div class="field">
        <label>Adaptaciones necesarias</label>
        <textarea rows="3" formControlName="adaptaciones"></textarea>
      </div>
    </section>
    }

    <!-- =====================================================
         PASO 4: FAMILIA Y CONTACTOS
    ====================================================== -->

    @if (step === 4) {
    <section class="form-section">
      <h2>Padres o tutores</h2>

      <!-- PADRE -->
      <div class="grid-2" formGroupName="padre">
        <div class="field">
          <label>Padre / Tutor 1 *</label>
          <input formControlName="nombreCompleto">
          @if (isInvalid('padre.nombreCompleto')) {
            <small class="error">Campo obligatorio.</small>
          }
        </div>

        <div class="field"><label>Fecha nacimiento</label><input type="date" formControlName="fechaNacimiento"></div>
        <div class="field"><label>Teléfono *</label><input formControlName="telefono"></div>
        <div class="field"><label>Teléfono secundario</label><input formControlName="telefonoSecundario"></div>
        <div class="field"><label>Email</label><input formControlName="correo"></div>
        <div class="field"><label>Ocupación</label><input formControlName="ocupacion"></div>
        <div class="field full"><label>Dirección laboral</label><input formControlName="direccionLaboral"></div>
      </div>

      <!-- MADRE -->
      <h3>Madre / Tutor 2</h3>
      <div formGroupName="madre" class="grid-2">
        <div class="field"><label>Nombre</label><input formControlName="nombreCompleto"></div>
        <div class="field"><label>Teléfono</label><input formControlName="telefono"></div>
        <div class="field"><label>Teléfono secundario</label><input formControlName="telefonoSecundario"></div>
        <div class="field"><label>Email</label><input formControlName="correo"></div>
      </div>

      <!-- TUTOR LEGAL -->
      <h3>Tutor legal</h3>
      <div formGroupName="tutorLegal" class="grid-2">
        <div class="field"><label>Nombre</label><input formControlName="nombreCompleto"></div>
        <div class="field"><label>Relación</label><input formControlName="relacion"></div>
        <div class="field"><label>Teléfono</label><input formControlName="telefono"></div>
        <div class="field"><label>¿Es tutor legal?</label><input type="checkbox" formControlName="esTutorLegal"></div>
      </div>

      <div class="field">
        <label>Identificación oficial</label>
        <input type="file" accept=".pdf,.jpg,.jpeg,.png" (change)="onFileChange($event, 'consentimiento')">
      </div>

      <!-- CONTACTOS DE EMERGENCIA -->
      <h3>Contactos de emergencia</h3>
      <div formArrayName="contactosEmergencia" class="contactos">

        @for (c of contactosArray.controls; track c; let i = $index) {
          <div class="contact-row" [formGroupName]="i">

            <div class="field"><label>Nombre *</label><input formControlName="nombreCompleto"></div>
            <div class="field"><label>Relación *</label><input formControlName="relacion"></div>
            <div class="field"><label>Teléfono *</label><input formControlName="telefono"></div>
            <div class="field"><label>Tel. secundario</label><input formControlName="telefonoSecundario"></div>
            <div class="field full"><label>Dirección</label><input formControlName="direccion"></div>

            @if (contactosArray.length > 2) {
            <button type="button" class="link-danger" (click)="eliminarContacto(i)">Eliminar</button>
            }
          </div>
        }

      </div>

      <button type="button" class="btn-outline small" (click)="agregarContacto()">+ Agregar contacto</button>
    </section>
    }

    <!-- =====================================================
         PASO 5: EMOCIONAL Y CENTRO
    ====================================================== -->

    @if (step === 5) {
    <section class="form-section">

      <h2>Información emocional / conductual</h2>

      <div formGroupName="infoEmocional">
        <div class="field"><label>Estímulos ansiedad</label><textarea rows="2" formControlName="estimulosAnsiedad"></textarea></div>
        <div class="field"><label>Cosas que calman</label><textarea rows="2" formControlName="cosasQueCalman"></textarea></div>
        <div class="field"><label>Preferencias sensoriales</label><textarea rows="2" formControlName="preferenciasSensoriales"></textarea></div>
        <div class="field"><label>Cosas que NO tolera</label><textarea rows="2" formControlName="cosasNoTolera"></textarea></div>
        <div class="field"><label>Palabras clave</label><textarea rows="2" formControlName="palabrasClave"></textarea></div>

        <div class="grid-2">
          <div class="field"><label>Forma de comunicación</label><input formControlName="formaComunicacion"></div>

          <div class="field">
            <label>Nivel de comprensión *</label>
            <select formControlName="nivelComprension">
              <option value="ALTO">Alto</option>
              <option value="MEDIO">Medio</option>
              <option value="BAJO">Bajo</option>
            </select>
          </div>
        </div>
      </div>

      <h2>Información del centro</h2>

      <div formGroupName="infoCentro">
        <div class="grid-3">
          <div class="field"><label>Fecha ingreso *</label><input type="date" formControlName="fechaIngreso"></div>
          <div class="field"><label>Costo mensual</label><input type="number" formControlName="costoMensual"></div>
          <div class="field"><label>Modalidad de pago</label><input formControlName="modalidadPago"></div>
        </div>

        <div class="field"><label>Terapeuta asignado</label><input formControlName="terapeutaAsignado"></div>
        <div class="field"><label>Horarios de terapia</label><input formControlName="horariosTerapia"></div>

        <div class="field">
          <label>Estado *</label>
          <select formControlName="estado">
            <option value="ACTIVO">Activo</option>
            <option value="INACTIVO">Inactivo</option>
          </select>
        </div>

        <div formGroupName="terapias" class="terapias">
          <label>Tipos de terapia</label>
          <div class="checkboxes">
            <label><input type="checkbox" formControlName="lenguaje"> Lenguaje</label>
            <label><input type="checkbox" formControlName="conductual"> Conductual</label>
            <label><input type="checkbox" formControlName="ocupacional"> Ocupacional</label>
            <label><input type="checkbox" formControlName="sensorial"> Sensorial</label>
            <label><input type="checkbox" formControlName="psicologia"> Psicología</label>
          </div>
        </div>
      </div>

      <h3>Documentos administrativos</h3>
      <div class="grid-3">
        <div class="field"><label>Acta nacimiento</label><input type="file" (change)="onFileChange($event,'acta')" accept=".pdf,.jpg,.jpeg,.png"></div>
        <div class="field"><label>CURP</label><input type="file" (change)="onFileChange($event,'curp')" accept=".pdf,.jpg,.jpeg,.png"></div>
        <div class="field"><label>Comprobante domicilio</label><input type="file" (change)="onFileChange($event,'comprobante')" accept=".pdf,.jpg,.jpeg,.png"></div>
      </div>

      <div class="grid-2">
        <div class="field"><label>Consentimiento firmado</label><input type="file" (change)="onFileChange($event,'consentimiento')" accept=".pdf,.jpg,.jpeg,.png"></div>
        <div class="field"><label>Hoja de ingreso</label><input type="file" (change)="onFileChange($event,'hojaIngreso')" accept=".pdf,.jpg,.jpeg,.png"></div>
      </div>
    </section>
    }

    <!-- =====================================================
         FOOTER BOTONERA
    ====================================================== -->
    <footer class="form-footer">
      
      <button
        type="button"
        class="btn-outline"
        (click)="prevStep()"
        [disabled]="step === 1">
        Anterior
      </button>

      <div class="spacer"></div>

      @if (step < 5) {
        <button type="button" class="btn-primary" (click)="nextStep()">
          Siguiente
        </button>
      }

      @if (step === 5) {
        <button type="submit" class="btn-primary" [disabled]="submitting">
          {{ submitting ? 'Guardando...' : (isEdit ? 'Guardar cambios' : 'Guardar') }}
        </button>
      }

    </footer>

  </form>

</div>
