<!-- ==============================
     TOAST NOTIFICATIONS
================================== -->
<div class="toast-container" aria-live="polite" aria-atomic="true">
  @if (mensajeError) {
    <div class="toast toast-error" (click)="mensajeError = ''">
      {{ mensajeError }}
    </div>
  }

  @if (mensajeInfo) {
    <div class="toast toast-info" (click)="mensajeInfo = ''">
      {{ mensajeInfo }}
    </div>
  }

  @if (cargando) {
    <div class="toast toast-loading">
      Procesando evaluación TOPSIS...
    </div>
  }
</div>


<!-- ==============================
     CONTENEDOR PRINCIPAL
================================== -->
<div class="topsis-container">

  <!-- HEADER -->
  <div class="page-header">
    <h2>Evaluación TOPSIS de Terapeutas</h2>
    <p class="subtitle">
      Sistema profesional de análisis multicriterio basado en carga de trabajo, experiencia y desempeño.
    </p>
  </div>

  <!-- ==============================
       CONFIGURACIÓN
  ================================= -->
  @if (mostrarConfiguracion && !resultado) {
    <section class="card config-card">

      <div class="card-header">
        <h3>Configuración de Evaluación</h3>
        <p>Define parámetros y pesos para tu análisis multicriterio</p>
      </div>

      <div class="card-body">

        <!-- FILTROS -->
        <div class="row mb-4">

          <div class="col-md-6">
            <label for="terapia-select" class="form-label">Terapia (opcional)</label>
            <select 
              id="terapia-select" 
              class="form-control"
              [(ngModel)]="terapiaId">
              <option [ngValue]="null">Todas las terapias</option>
              @for (terapia of terapiasDisponibles; track terapia.id_terapia) {
                <option [ngValue]="terapia.id_terapia">{{ terapia.nombre }}</option>
              }
            </select>
            <small class="text-muted">Selecciona una terapia para evaluar especialidad específica.</small>
          </div>

          <div class="col-md-6 d-flex align-items-center">
            <div class="form-check">
              <input 
                id="incluir-inactivos" 
                type="checkbox" 
                class="form-check-input" 
                [(ngModel)]="incluirInactivos"/>
              <label for="incluir-inactivos" class="form-check-label">
                Incluir terapeutas inactivos
              </label>
            </div>
          </div>

        </div>

        <!-- PESOS -->
        <div class="pesos-section">

          <h4>
            Pesos de Criterios
            <small class="text-muted ms-2">(Suma: {{ getSumaPesos() | number:'1.3-3' }})</small>
          </h4>

          <div class="peso-group">
            <label for="peso-carga">Sesiones por semana (Carga laboral)</label>
            <span class="peso-value">{{ pesos.carga_laboral | number:'1.2-2' }}</span>
            <input 
              id="peso-carga" 
              type="range"
              min="0" max="1" step="0.01"
              [(ngModel)]="pesos.carga_laboral"/>
            <small class="text-muted">Menor carga implica mayor disponibilidad.</small>
          </div>

          <div class="peso-group">
            <label for="peso-pacientes">Total de pacientes atendidos</label>
            <span class="peso-value">{{ pesos.sesiones_completadas | number:'1.2-2' }}</span>
            <input 
              id="peso-pacientes" 
              type="range" 
              min="0" max="1" step="0.01"
              [(ngModel)]="pesos.sesiones_completadas"/>
            <small class="text-muted">Mayor número implica más experiencia.</small>
          </div>

          <div class="peso-group">
            <label for="peso-rating">Rating del terapeuta</label>
            <span class="peso-value">{{ pesos.rating | number:'1.2-2' }}</span>
            <input 
              id="peso-rating" 
              type="range"
              min="0" max="1" step="0.01"
              [(ngModel)]="pesos.rating"/>
            <small class="text-muted">Mejor rating refleja mayor desempeño.</small>
          </div>

          <div class="peso-group">
            <label for="peso-especialidad">Match de especialidad</label>
            <span class="peso-value">{{ pesos.especialidad | number:'1.2-2' }}</span>
            <input 
              id="peso-especialidad" 
              type="range"
              min="0" max="1" step="0.01"
              [(ngModel)]="pesos.especialidad"/>
            <small class="text-muted">Compatibilidad con la terapia solicitada.</small>
          </div>

          <div class="suma-pesos" [class.suma-invalida]="!validarPesos()">
            <strong>Suma total:</strong> {{ getSumaPesos() | number:'1.3-3' }}
          </div>

        </div>

        <!-- BOTONES -->
        <div class="actions-row">
          <button 
            class="btn btn-secondary"
            (click)="normalizarPesos()"
            [disabled]="cargando">
            Normalizar pesos
          </button>

          <button 
            class="btn btn-primary"
            (click)="calcular()"
            [disabled]="cargando || !validarPesos()">
            Calcular evaluación
          </button>
        </div>

      </div>
    </section>
  }

  <!-- ==============================
       RESULTADOS
  ================================= -->
  @if (resultado && resultado.ranking.length > 0) {

    <section class="results-section">

      <div class="card results-card">

        <div class="card-header">
          <h3>Resultados TOPSIS</h3>
          <button class="btn btn-outline-primary btn-sm" (click)="nuevaEvaluacion()">
            Nueva evaluación
          </button>
        </div>

        <div class="card-body">

          <div class="result-summary">
            <div class="summary-item">
              <span class="label">Terapeutas evaluados</span>
              <span class="value">{{ resultado.total_evaluados }}</span>
            </div>

            @if (resultado.terapia_solicitada) {
              <div class="summary-item">
                <span class="label">Terapia solicitada</span>
                <span class="value badge badge-info">ID {{ resultado.terapia_solicitada }}</span>
              </div>
            }
          </div>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Ranking</th>
                  <th>Terapeuta</th>
                  <th>Especialidad</th>
                  <th>Puntaje</th>
                  <th>Sesiones</th>
                  <th>Pacientes</th>
                  <th>Rating</th>
                  <th>Match</th>
                </tr>
              </thead>

              <tbody>
                @for (terapeuta of resultado.ranking; track terapeuta.terapeuta_id) {
                  <tr>
                    <td>#{{ terapeuta.ranking }}</td>
                    <td>
                      <strong>{{ terapeuta.nombre }}</strong><br>
                      <small class="text-muted">ID {{ terapeuta.terapeuta_id }}</small>
                    </td>
                    <td>{{ terapeuta.especialidad_principal || '-' }}</td>
                    <td>{{ formatNumber(terapeuta.score) }}</td>
                    <td class="text-center">{{ terapeuta.metricas.carga_laboral }}</td>
                    <td class="text-center">{{ terapeuta.metricas.sesiones_completadas }}</td>
                    <td class="text-center">{{ formatNumber(terapeuta.metricas.rating) }}</td>
                    <td class="text-center">
                      @if (terapeuta.metricas.especialidad_match) {
                        ✓
                      } @else {
                        -
                      }
                    </td>
                  </tr>
                }
              </tbody>

            </table>
          </div>

        </div>
      </div>
    </section>

  }

</div>
