<div class="topsis-container">
  <!-- ==============================
       HEADER
  ================================= -->
  <div class="page-header">
    <h2>ğŸ§® EvaluaciÃ³n TOPSIS de Terapeutas</h2>
    <p class="subtitle">Sistema profesional de anÃ¡lisis multicriterio con datos reales</p>
  </div>

  <!-- ==============================
       ALERTAS
  ================================= -->
  @if (mensajeError) {
    <div class="alert alert-danger">
      <span class="icon">âš ï¸</span>
      <span>{{ mensajeError }}</span>
    </div>
  }

  @if (mensajeInfo) {
    <div class="alert alert-info">
      <span class="icon">â„¹ï¸</span>
      <span>{{ mensajeInfo }}</span>
    </div>
  }

  @if (cargando) {
    <div class="alert alert-info">
      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
      <span>Procesando evaluaciÃ³n TOPSIS...</span>
    </div>
  }

  <!-- ==============================
       INFORMACIÃ“N TOPSIS
  ================================= -->
  @if (!resultado) {
    <div class="alert alert-primary">
      <h5><strong>ğŸ¯ Â¿CÃ³mo funciona TOPSIS?</strong></h5>
      <p class="mb-2">
        TOPSIS evalÃºa a cada terapeuta en <strong>4 criterios</strong> y calcula quiÃ©n estÃ¡ mÃ¡s cerca de la "soluciÃ³n ideal":
      </p>
      <ol class="mb-2">
        <li><strong>ğŸ“… Sesiones Semanales</strong> (COSTO â¬‡ï¸): Menos sesiones = MÃ¡s disponibilidad para nuevos pacientes</li>
        <li><strong>ğŸ‘¥ Total de Pacientes</strong> (BENEFICIO â¬†ï¸): MÃ¡s pacientes atendidos = Mayor experiencia prÃ¡ctica</li>
        <li><strong>â­ Rating</strong> (BENEFICIO â¬†ï¸): CalificaciÃ³n de 0-5 basada en evaluaciones histÃ³ricas</li>
        <li><strong>ğŸ“ Match de Especialidad</strong> (BENEFICIO â¬†ï¸): Coincidencia entre especialidad y terapia solicitada</li>
      </ol>
      <p class="mb-0">
        <strong>ğŸ’¡ Resultado:</strong> Los terapeutas con <strong>menos carga</strong>, <strong>mÃ¡s experiencia</strong>, 
        <strong>mejor rating</strong> y <strong>especialidad correcta</strong> obtienen los rankings mÃ¡s altos.
      </p>
    </div>
  }

  <!-- ==============================
       CONFIGURACIÃ“N
  ================================= -->
  @if (mostrarConfiguracion && !resultado) {
    <section class="card config-card">
      <div class="card-header">
        <h3>âš™ï¸ ConfiguraciÃ³n de EvaluaciÃ³n</h3>
        <p>Personaliza los criterios y pesos para la evaluaciÃ³n</p>
      </div>
      <div class="card-body">
        
        <!-- Filtros opcionales -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="terapia-select" class="form-label">
              <span class="icon">ğŸ¯</span>
              Terapia especÃ­fica (opcional)
            </label>
            <select 
              id="terapia-select" 
              class="form-control" 
              [(ngModel)]="terapiaId"
            >
              <option [ngValue]="null">Todas las terapias</option>
              @for (terapia of terapiasDisponibles; track terapia.id_terapia) {
                <option [ngValue]="terapia.id_terapia">{{ terapia.nombre }}</option>
              }
            </select>
            <small class="text-muted">
              Selecciona una terapia para verificar especialidad especÃ­fica o deja "Todas" para evaluaciÃ³n general
            </small>
          </div>

          <div class="col-md-6 d-flex align-items-center">
            <div class="form-check">
              <input 
                id="incluir-inactivos" 
                type="checkbox" 
                class="form-check-input" 
                [(ngModel)]="incluirInactivos"
              />
              <label for="incluir-inactivos" class="form-check-label">
                Incluir terapeutas inactivos
              </label>
            </div>
          </div>
        </div>

        <!-- ConfiguraciÃ³n de pesos -->
        <div class="pesos-section">
          <h4 class="mb-3">
            <span class="icon">âš–ï¸</span>
            Pesos de Criterios
            <small class="text-muted ms-2">(Suma actual: {{ getSumaPesos() | number:'1.3-3' }})</small>
          </h4>

          <div class="peso-group">
            <label for="peso-carga">
              <span class="icon">ğŸ“…</span>
              <strong>Sesiones Semanales (Carga)</strong>
              <span class="badge badge-primary ms-2">{{ pesos.carga_laboral | number:'1.2-2' }}</span>
            </label>
            <input
              id="peso-carga"
              type="range"
              class="form-range"
              min="0"
              max="1"
              step="0.01"
              [(ngModel)]="pesos.carga_laboral"
            />
            <small class="text-muted">â¬‡ï¸ COSTO: Menos sesiones = MÃ¡s disponibilidad</small>
          </div>

          <div class="peso-group">
            <label for="peso-sesiones">
              <span class="icon">ğŸ‘¥</span>
              <strong>Total de Pacientes (Experiencia)</strong>
              <span class="badge badge-primary ms-2">{{ pesos.sesiones_completadas | number:'1.2-2' }}</span>
            </label>
            <input
              id="peso-sesiones"
              type="range"
              class="form-range"
              min="0"
              max="1"
              step="0.01"
              [(ngModel)]="pesos.sesiones_completadas"
            />
            <small class="text-muted">â¬†ï¸ BENEFICIO: MÃ¡s pacientes = MÃ¡s experiencia</small>
          </div>

          <div class="peso-group">
            <label for="peso-rating">
              <span class="icon">â­</span>
              <strong>Rating (Calidad)</strong>
              <span class="badge badge-primary ms-2">{{ pesos.rating | number:'1.2-2' }}</span>
            </label>
            <input
              id="peso-rating"
              type="range"
              class="form-range"
              min="0"
              max="1"
              step="0.01"
              [(ngModel)]="pesos.rating"
            />
            <small class="text-muted">â¬†ï¸ BENEFICIO: Mayor rating = Mejor evaluado</small>
          </div>

          <div class="peso-group">
            <label for="peso-especialidad">
              <span class="icon">ğŸ“</span>
              <strong>Match de Especialidad</strong>
              <span class="badge badge-primary ms-2">{{ pesos.especialidad | number:'1.2-2' }}</span>
            </label>
            <input
              id="peso-especialidad"
              type="range"
              class="form-range"
              min="0"
              max="1"
              step="0.01"
              [(ngModel)]="pesos.especialidad"
            />
            <small class="text-muted">â¬†ï¸ BENEFICIO: Coincidencia con la terapia solicitada</small>
          </div>

          <!-- ValidaciÃ³n de suma -->
          <div class="suma-pesos" [class.suma-invalida]="!validarPesos()">
            <strong>Suma de pesos:</strong> {{ getSumaPesos() | number:'1.3-3' }}
            @if (!validarPesos()) {
              <span class="text-danger ms-2">âš ï¸ Debe ser 1.0</span>
            } @else {
              <span class="text-success ms-2">âœ“ VÃ¡lido</span>
            }
          </div>
        </div>

        <!-- Acciones -->
        <div class="actions-row">
          <button 
            class="btn btn-secondary" 
            (click)="normalizarPesos()"
            [disabled]="cargando"
          >
            <span class="icon">ğŸ”§</span>
            Normalizar Pesos
          </button>

          <button 
            class="btn btn-primary" 
            (click)="calcular()"
            [disabled]="cargando || !validarPesos()"
          >
            <span class="icon">ğŸ§®</span>
            Calcular EvaluaciÃ³n TOPSIS
          </button>
        </div>
      </div>
    </section>
  }

  <!-- ==============================
       RESULTADOS
  ================================= -->
  @if (resultado && resultado.ranking.length > 0) {
    <section class="results-section">
      <div class="card results-card">
        <div class="card-header">
          <h3>ğŸ“Š Resultados de EvaluaciÃ³n</h3>
          <button class="btn btn-sm btn-outline-primary" (click)="nuevaEvaluacion()">
            <span class="icon">ğŸ”„</span>
            Nueva EvaluaciÃ³n
          </button>
        </div>
        <div class="card-body">
          
          <!-- Resumen -->
          <div class="result-summary">
            <div class="summary-item">
              <span class="label">Terapeutas evaluados:</span>
              <span class="value">{{ resultado.total_evaluados }}</span>
            </div>
            @if (resultado.terapia_solicitada) {
              <div class="summary-item">
                <span class="label">Terapia solicitada:</span>
                <span class="value badge badge-info">ID: {{ resultado.terapia_solicitada }}</span>
              </div>
            }
          </div>

          <!-- Tabla de ranking -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Ranking</th>
                  <th>Terapeuta</th>
                  <th>Especialidad</th>
                  <th>Score TOPSIS</th>
                  <th>ğŸ“… Sesiones/Sem</th>
                  <th>ğŸ‘¥ Pacientes</th>
                  <th>â­ Rating</th>
                  <th>ğŸ“ Match</th>
                </tr>
              </thead>
              <tbody>
                @for (terapeuta of resultado.ranking; track terapeuta.terapeuta_id) {
                  <tr>
                    <td>
                      <span 
                        class="badge"
                        [ngClass]="getRankingBadgeClass(terapeuta.ranking)"
                      >
                        #{{ terapeuta.ranking }}
                      </span>
                    </td>
                    <td>
                      <strong>{{ terapeuta.nombre }}</strong>
                      <br>
                      <small class="text-muted">ID: {{ terapeuta.terapeuta_id }}</small>
                    </td>
                    <td>
                      @if (terapeuta.especialidad_principal) {
                        <span class="badge badge-secondary">{{ terapeuta.especialidad_principal }}</span>
                      } @else {
                        <span class="text-muted">-</span>
                      }
                    </td>
                    <td>
                      <div class="score-cell">
                        <strong [style.color]="getScoreColor(terapeuta.score)">
                          {{ formatNumber(terapeuta.score) }}
                        </strong>
                        <div class="progress">
                          <div 
                            class="progress-bar" 
                            [style.width.%]="terapeuta.score * 100"
                            [style.backgroundColor]="getScoreColor(terapeuta.score)"
                          ></div>
                        </div>
                      </div>
                    </td>
                    <td class="text-center">{{ terapeuta.metricas.carga_laboral }}</td>
                    <td class="text-center">{{ terapeuta.metricas.sesiones_completadas }}</td>
                    <td class="text-center">
                      <span class="badge badge-warning">
                        â­ {{ formatNumber(terapeuta.metricas.rating) }}
                      </span>
                    </td>
                    <td class="text-center">
                      @if (terapeuta.metricas.especialidad_match) {
                        <span class="text-success">âœ“</span>
                      } @else {
                        <span class="text-muted">-</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Pesos aplicados -->
          <div class="pesos-aplicados mt-4">
            <h5>âš–ï¸ Pesos Aplicados</h5>
            <div class="pesos-grid">
              <div class="peso-item">
                <span class="label">Carga Laboral:</span>
                <span class="value">{{ resultado.pesos_aplicados.carga_laboral | number:'1.2-2' }}</span>
              </div>
              <div class="peso-item">
                <span class="label">Sesiones:</span>
                <span class="value">{{ resultado.pesos_aplicados.sesiones_completadas | number:'1.2-2' }}</span>
              </div>
              <div class="peso-item">
                <span class="label">Rating:</span>
                <span class="value">{{ resultado.pesos_aplicados.rating | number:'1.2-2' }}</span>
              </div>
              <div class="peso-item">
                <span class="label">Especialidad:</span>
                <span class="value">{{ resultado.pesos_aplicados.especialidad | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  }

  @if (resultado && resultado.ranking.length === 0) {
    <div class="alert alert-warning">
      <span class="icon">âš ï¸</span>
      <span>No se encontraron terapeutas para evaluar. Verifica los filtros y que existan terapeutas activos.</span>
    </div>
  }
</div>
