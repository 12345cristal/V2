"""\nRecurso Service - Lógica de negocio para recursos y tareas\n"""\n\nfrom typing import List, Optional\nfrom sqlalchemy.orm import Session, joinedload\nfrom sqlalchemy import or_\nfrom fastapi import HTTPException, status\n\nfrom app.models.recurso import Recurso, TareaRecurso\nfrom app.models.personal import Personal\nfrom app.models.nino import Nino\nfrom app.schemas.recurso import RecursoCreate, RecursoUpdate, TareaRecursoCreate\n\n\nclass RecursoService:\n    """Servicio para gestión de recursos educativos"""\n    \n    @staticmethod\n    def get_recurso_list(\n        db: Session,\n        skip: int = 0,\n        limit: int = 100,\n        search: Optional[str] = None,\n        tipo_id: Optional[int] = None,\n        categoria_id: Optional[int] = None,\n        nivel_id: Optional[int] = None,\n        es_destacado: Optional[bool] = None,\n    ) -> List[Recurso]:\n        """Obtener lista de recursos con filtros"""\n        query = db.query(Recurso).options(\n            joinedload(Recurso.personal),\n            joinedload(Recurso.tipo),\n            joinedload(Recurso.categoria),\n            joinedload(Recurso.nivel),\n        )\n        \n        if search:\n            search_filter = f\"%{search}%\"\n            query = query.filter(\n                or_(\n                    Recurso.titulo.ilike(search_filter),\n                    Recurso.descripcion.ilike(search_filter),\n                    Recurso.etiquetas.ilike(search_filter),\n                )\n            )\n        \n        if tipo_id:\n            query = query.filter(Recurso.tipo_id == tipo_id)\n        \n        if categoria_id:\n            query = query.filter(Recurso.categoria_id == categoria_id)\n        \n        if nivel_id:\n            query = query.filter(Recurso.nivel_id == nivel_id)\n        \n        if es_destacado is not None:\n            query = query.filter(Recurso.es_destacado == (1 if es_destacado else 0))\n        \n        return query.order_by(Recurso.fecha_publicacion.desc()).offset(skip).limit(limit).all()\n    \n    @staticmethod\n    def get_recurso_by_id(db: Session, recurso_id: int) -> Recurso:\n        """Obtener recurso por ID"""\n        recurso = (\n            db.query(Recurso)\n            .options(\n                joinedload(Recurso.personal),\n                joinedload(Recurso.tipo),\n                joinedload(Recurso.categoria),\n                joinedload(Recurso.nivel),\n            )\n            .filter(Recurso.id == recurso_id)\n            .first()\n        )\n        \n        if not recurso:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=f\"Recurso con ID {recurso_id} no encontrado\",\n            )\n        \n        return recurso\n    \n    @staticmethod\n    def create_recurso(db: Session, recurso_data: RecursoCreate) -> Recurso:\n        """Crear nuevo recurso"""\n        personal = db.query(Personal).filter(Personal.id == recurso_data.personal_id).first()\n        if not personal:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=f\"Personal con ID {recurso_data.personal_id} no encontrado\",\n            )\n        \n        recurso = Recurso(**recurso_data.model_dump())\n        db.add(recurso)\n        db.commit()\n        db.refresh(recurso)\n        return recurso\n    \n    @staticmethod\n    def update_recurso(\n        db: Session,\n        recurso_id: int,\n        recurso_data: RecursoUpdate,\n    ) -> Recurso:\n        """Actualizar recurso"""\n        recurso = RecursoService.get_recurso_by_id(db, recurso_id)\n        \n        update_data = recurso_data.model_dump(exclude_unset=True)\n        for field, value in update_data.items():\n            setattr(recurso, field, value)\n        \n        db.commit()\n        db.refresh(recurso)\n        return recurso\n    \n    @staticmethod\n    def delete_recurso(db: Session, recurso_id: int) -> dict:\n        """Eliminar recurso (hard delete)"""\n        recurso = RecursoService.get_recurso_by_id(db, recurso_id)\n        db.delete(recurso)\n        db.commit()\n        return {\"message\": f\"Recurso {recurso_id} eliminado exitosamente\"}\n    \n    @staticmethod\n    def asignar_tarea(db: Session, tarea_data: TareaRecursoCreate) -> TareaRecurso:\n        """Asignar recurso como tarea a un niño"""\n        RecursoService.get_recurso_by_id(db, tarea_data.recurso_id)\n        \n        nino = db.query(Nino).filter(Nino.id == tarea_data.nino_id).first()\n        if not nino:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=f\"Niño con ID {tarea_data.nino_id} no encontrado\",\n            )\n        \n        tarea = TareaRecurso(**tarea_data.model_dump())\n        db.add(tarea)\n        db.commit()\n        db.refresh(tarea)\n        return tarea\n    \n    @staticmethod\n    def get_tareas_nino(db: Session, nino_id: int, completado: Optional[bool] = None) -> List[TareaRecurso]:\n        """Obtener tareas asignadas a un niño"""\n        query = db.query(TareaRecurso).options(\n            joinedload(TareaRecurso.recurso),\n            joinedload(TareaRecurso.nino),\n        ).filter(TareaRecurso.nino_id == nino_id)\n        \n        if completado is not None:\n            query = query.filter(TareaRecurso.completado == (1 if completado else 0))\n        \n        return query.all()\n    \n    @staticmethod\n    def marcar_tarea_completada(db: Session, tarea_id: int) -> TareaRecurso:\n        """Marcar tarea como completada"""\n        tarea = db.query(TareaRecurso).filter(TareaRecurso.id == tarea_id).first()\n        if not tarea:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=f\"Tarea con ID {tarea_id} no encontrada\",\n            )\n        \n        tarea.completado = 1\n        db.commit()\n        db.refresh(tarea)\n        return tarea\n\n\n# Instancia global del servicio\nrecurso_service = RecursoService()\n